---
title: "City Hall Indoor/Outdoor Data Outlier Filtering"
author: "Megan Ku"
---
# Description

This code filters data from the Revere City Hall and VFW HEPA pilots, removing 
outliers.

# Environment Setup 

Beforehand, we will import the necessary libraries. 

```{r, warning= FALSE, error = FALSE}
library(lubridate) #date and time functions 
library(data.table) #to use the data.table variable type
library(dplyr) #this library allows you to use the %>% operator
library(tidyr) # use the complete function to account for time syncing
library(openair) #for plotting and analysis
library(stringr)
library(ggplot2)
library(gtable)
library(grid)
source("../filter_data.R") #For filtering data
```

# Import Data

```{r}
auditor_merged <- import_ratio_data("../data/merged/CH_auditor_merged.csv")
mainroom_merged <- import_ratio_data("../data/merged/CH_mainroom_merged.csv")
waterdept_merged <- import_ratio_data("../data/merged/CH_waterdept_merged.csv")
engineering_merged <- import_ratio_data("../data/merged/CH_engineering_merged.csv")
veterans_merged <- import_ratio_data("../data/merged/CH_veterans_merged.csv")
clerk_merged <- import_ratio_data("../data/merged/CH_clerk_merged.csv")
```

# Removing Outliers

We're going to manually remove outliers from each dataset according to visual 
cues, including the presence of indoor sources (a sharp increase followed by a 
decay) and RF interfereence (sharp concentrated spikes much higher than the 
underlying trend).

## Outdoor data

### Clerk and Auditor

There was some RF interference identified in the outdoor data used for the Clerk
and Auditor rooms. This is identified by the drastic spikes that only occur for 
singular points that deviate from the underlying curve of the data.
We manually remove that below by setting a threshold cutoff for the time period
where RF interference is visually present (between January 14th and noon on 
January 16th).

```{r, fig.height=10}
auditor <- auditor_merged[
  !(auditor_merged$date1min > as.POSIXct("2021-01-14 00:00:00", tz='America/New_York') &
  auditor_merged$date1min < as.POSIXct("2021-01-16 09:05:00", tz='America/New_York') &
  auditor_merged$pm25.outdoor > 40), ]

clerk<- clerk_merged[
  !(clerk_merged$date1min > as.POSIXct("2021-01-14 00:00:00", tz='America/New_York') &
  clerk_merged$date1min < as.POSIXct("2021-01-16 09:05:00", tz='America/New_York') &
  clerk_merged$pm25.outdoor > 40), ]

auditor <- complete(auditor, date1min = seq(min(date1min, na.rm=TRUE), 
                                    max(date1min, na.rm=TRUE), 
                                    by = "min"))

clerk <- complete(clerk, date1min = seq(min(date1min, na.rm=TRUE), 
                                    max(date1min, na.rm=TRUE), 
                                    by = "min"))

plot_time_resolved(auditor_merged, TRUE)
plot_time_resolved(auditor, TRUE)
plot_time_resolved(clerk_merged, FALSE)
plot_time_resolved(clerk, FALSE)
```

There was also an outlier in the Mainroom and Veterans outdoor data. On January 
26th, right before midnight, there is a singular outdoor spike for one data 
point only in the Mod-PM data and for two data points in the CPC data. The spike
is both incredibly small in duration and incredibly large in magnitude (larger
than 99% of all datapoints by several standard deviations) that we selected to 
omit them.

### Veterans and Mainroom

```{r, fig.height=10}
mainroom <- set_NA(mainroom_merged, "2021-01-26 23:55:00", "2021-01-26 23:58:00")
veterans <- set_NA(veterans_merged, "2021-01-26 23:55:00", "2021-01-26 23:58:00")
mainroom <- set_NA(mainroom, "2021-01-28 16:58:00", "2021-01-28 17:00:00")
veterans <- set_NA(veterans, "2021-01-28 16:58:00", "2021-01-28 17:00:00")
mainroom <- complete(mainroom, date1min = seq(min(date1min, na.rm=TRUE), 
                                    max(date1min, na.rm=TRUE), 
                                    by = "min"))
veterans <- complete(veterans, date1min = seq(min(date1min, na.rm=TRUE), 
                                    max(date1min, na.rm=TRUE), 
                                    by = "min"))

plot_time_resolved(mainroom_merged, TRUE)
plot_time_resolved(veterans_merged, FALSE)
plot_time_resolved(mainroom, TRUE)
plot_time_resolved(veterans, FALSE)
```
## Indoor Data

With the indoor data, we sought to identify and remove signs of indoor sources
of particulate matter and UFPs. These can be identified by a sharp spike in the 
indoor particle concentrations, followed by a return to background levels. Note 
that these spikes have no correlated increases in the outdoor data, leading to 
the conclusion that the particles were generated indoors

There are two notable shapes that suggest the presence of an indoor source:
1. Cleaning - this can be identified by a spike in larger particle
concentrations indoors (PM10 primarily, PM2.5 secondarily).

2. Fine particle source - a fine particle source is easily noticeable by its 
shape - a near vertical spike upward followed by an exponential decay. This
spike is noticeable across all particle sizes.

We omit instances of these source spikes, including their related outdoor data, 
in this step. For fine particle sources, we store only the decay portion of the 
event for further analysis.

## Auditor Room

```{r, fig.height=10}
# Cleaning source 1/13
auditor_filt <- set_NA(auditor, "2021-01-13 15:35:00", "2021-01-13 15:47:00")

# Fine particle source - 1/14
auditor_indoor_src <- auditor_filt[
  auditor$date1min > as.POSIXct("2021-01-14 08:48:00", tz='America/New_York') &
  auditor$date1min < as.POSIXct("2021-01-14 10:37:00", tz='America/New_York'), ]

auditor_filt <- set_NA(auditor_filt, "2021-01-14 8:47:00", "2021-01-14 10:37:00")

# Fine particle source - 1/20
auditor_indoor_src <- rbind(auditor_indoor_src, auditor_filt[
  (auditor_filt$date1min > as.POSIXct("2021-01-20 08:00:00", tz='America/New_York') &
  auditor_filt$date1min < as.POSIXct("2021-01-20 10:20:00", tz='America/New_York')),
  ])

auditor_filt <- set_NA(auditor_filt, "2021-01-20 07:51:00", "2021-01-20 10:20:00")

# Indoor cleaning source - 1/20
auditor_filt <- set_NA(auditor_filt, "2021-01-20 10:19:00", "2021-01-20 14:33:00")

# Fine particle source - 1/22
auditor_indoor_src <- rbind(auditor_indoor_src, auditor_filt[
  (auditor_filt$date1min > as.POSIXct("2021-01-22 10:25:00", tz='America/New_York') &
  auditor_filt$date1min < as.POSIXct("2021-01-22 14:43:00", tz='America/New_York')),
  ])

auditor_filt <- set_NA(auditor_filt, "2021-01-22 10:22:00", "2021-01-22 14:43:00")

# Fine particle source - 1/23
auditor_indoor_src <- rbind(auditor_indoor_src, auditor_filt[
  (auditor_filt$date1min > as.POSIXct("2021-01-23 07:24:00", tz='America/New_York') &
  auditor_filt$date1min < as.POSIXct("2021-01-23 08:03:00", tz='America/New_York')),
  ])

auditor_filt <- set_NA(auditor_filt, "2021-01-23 07:22:00", "2021-01-23 08:03:00")

auditor_indoor_src <- complete(auditor_indoor_src, date1min = seq(min(auditor_filt$date1min, na.rm=TRUE), 
                                    max(auditor_filt$date1min, na.rm=TRUE), 
                                    by = "min"))

plot_time_resolved(auditor, TRUE)
plot_time_resolved(auditor_indoor_src, TRUE)
plot_time_resolved(auditor_filt, TRUE)
```

## Clerk's Office

```{r, fig.height=10}
# Fine particle source - 1/14
clerk_indoor_src <- clerk[
  clerk$date1min > as.POSIXct("2021-01-14 15:46:00", tz='America/New_York') &
  clerk$date1min < as.POSIXct("2021-01-14 16:21:00", tz='America/New_York'), ]

clerk_filt <- set_NA(clerk, "2021-01-14 15:44:00", "2021-01-14 16:21:00")

# Fine particle source - 1/16
clerk_indoor_src <- rbind(clerk_indoor_src, clerk_filt[
  clerk_filt$date1min > as.POSIXct("2021-01-16 11:38:00", tz='America/New_York') &
  clerk_filt$date1min < as.POSIXct("2021-01-16 17:21:00", tz='America/New_York'), ])

clerk_filt <- set_NA(clerk_filt, "2021-01-16 10:51:00", "2021-01-16 17:21:00")

# Fine particle source - 1/20
clerk_indoor_src <- rbind(clerk_indoor_src, clerk_filt[
  clerk_filt$date1min > as.POSIXct("2021-01-20 06:08:00", tz='America/New_York') &
  clerk_filt$date1min < as.POSIXct("2021-01-20 07:50:00", tz='America/New_York'), ])

clerk_filt <- set_NA(clerk_filt, "2021-01-20 06:04:00", "2021-01-20 07:50:00")

# Cleaning sources - 1/20
clerk_filt <- set_NA(clerk_filt, "2021-01-20 11:10:00", "2021-01-20 11:38:00")
clerk_filt <- set_NA(clerk_filt, "2021-01-20 11:51:00", "2021-01-20 15:09:00")

# cleaning source - 1/23
clerk_filt <- set_NA(clerk_filt, "2021-01-23 07:26:00", "2021-01-23 08:17:00")

# Fine particle source - 1/23
clerk_indoor_src <- rbind(clerk_indoor_src, clerk_filt[
  clerk_filt$date1min > as.POSIXct("2021-01-23 10:45:00", tz='America/New_York') &
  clerk_filt$date1min < as.POSIXct("2021-01-23 12:44:00", tz='America/New_York'), ])

clerk_filt <- set_NA(clerk_filt, "2021-01-23 10:39:00", "2021-01-23 12:44:00")


clerk_indoor_src <- complete(clerk_indoor_src, date1min = seq(min(clerk_filt$date1min, na.rm=TRUE), 
                                    max(clerk_filt$date1min, na.rm=TRUE), 
                                    by = "min"))
plot_time_resolved(clerk)
plot_time_resolved(clerk_indoor_src)
plot_time_resolved(clerk_filt)
```

## Engineering

```{r, fig.height=10}
# Remove zero value
engineering <- engineering_merged[
  !(engineering_merged$date1min == as.POSIXct("2021-01-06 11:48:00", tz='America/New_York')), ]

# Fine particle source - 1/7
engineering_indoor_src <- engineering[
  engineering$date1min > as.POSIXct("2021-01-07 12:15:00", tz='America/New_York') &
  engineering$date1min < as.POSIXct("2021-01-07 12:38:00", tz='America/New_York'), ]

engineering_filt <- set_NA(engineering, 
                           "2021-01-07 12:09:00", "2021-01-07 12:38:00")

# Fine particle source - 1/9
engineering_indoor_src <- rbind(engineering_indoor_src, engineering_filt[
  (engineering_filt$date1min > as.POSIXct("2021-01-09 10:48:00", tz='America/New_York') &
  engineering_filt$date1min < as.POSIXct("2021-01-09 13:34:00", tz='America/New_York')),
  ])

engineering_filt <- set_NA(engineering_filt,
                           "2021-01-09 09:59:00","2021-01-09 13:34:00")

# Indoor source on 1/12
engineering_indoor_src <- rbind(engineering_indoor_src, engineering_filt[
  (engineering_filt$date1min > as.POSIXct("2021-01-12 10:24:00", tz='America/New_York') &
  engineering_filt$date1min < as.POSIXct("2021-01-12 10:43:00", tz='America/New_York')),
  ])

engineering_filt <- set_NA(engineering_filt, 
                           "2021-01-12 10:22:00", "2021-01-12 10:43:00")

# Cleaning sources - 1/13

engineering_filt <- set_NA(engineering_filt, 
                           "2021-01-13 06:38:00", "2021-01-13 08:16:00")

engineering_filt <- set_NA(engineering_filt, 
                           "2021-01-13 10:12:00", "2021-01-13 11:15:00")

engineering_indoor_src <- complete(
  engineering_indoor_src, 
  date1min = seq(min(engineering_filt$date1min, na.rm=TRUE),
                 max(engineering_filt$date1min, na.rm=TRUE), by = "min"))

engineering_merged <- complete(
  engineering_merged, 
  date1min = seq(min(date1min, na.rm=TRUE),
                 max(date1min, na.rm=TRUE), by = "min"))

plot_time_resolved(engineering_merged, FALSE)
plot_time_resolved(engineering_filt, FALSE)
plot_time_resolved(engineering_indoor_src, FALSE)
```

## Mainroom

```{r, fig.height=10}

# Remove bad CPC data
mainroom_filt <- mainroom
mainroom_filt$concent_1.indoor[
  mainroom_filt$date1min > as.POSIXct("2021-01-26 04:42:00") &
    mainroom_filt$date1min < as.POSIXct("2021-01-27 12:30:00")] <- NA

mainroom_filt$concent_1.outdoor[
  mainroom_filt$date1min > as.POSIXct("2021-01-26 04:42:00") &
    mainroom_filt$date1min < as.POSIXct("2021-01-27 12:30:00")] <- NA

mainroom_filt$concent_1.outdoor[
  mainroom_filt$date1min > as.POSIXct("2021-01-27 19:52:00")] <- NA

mainroom_filt$concent_ratio[
  mainroom_filt$date1min > as.POSIXct("2021-01-26 04:42:00") &
    mainroom_filt$date1min < as.POSIXct("2021-01-27 12:30:00")] <- NA

mainroom_filt <- complete(mainroom_filt, date1min = seq(min(date1min, na.rm=TRUE), 
                                    max(date1min, na.rm=TRUE), 
                                    by = "min"))

# Fine particle source - 1/25
mainroom_indoor_src <- mainroom_filt[
  mainroom_filt$date1min > as.POSIXct(
    "2021-01-25 17:15:00", tz='America/New_York') &
  mainroom_filt$date1min < as.POSIXct(
    "2021-01-25 18:52:00", tz='America/New_York'), ]

mainroom_filt <- set_NA(mainroom_filt, 
                        "2021-01-25 17:12:00", "2021-01-25 18:52:00")

# Cleaning sources - 1/27
mainroom_filt <- set_NA(mainroom_filt, 
                        "2021-01-27 07:32:00", "2021-01-27 10:40:00")

mainroom_filt <- set_NA(mainroom_filt, 
                        "2021-01-27 11:22:00", "2021-01-27 11:30:00")

# Fine particle source - 1/28
mainroom_indoor_src <- rbind(mainroom_indoor_src, mainroom_filt[
  mainroom_filt$date1min > as.POSIXct("2021-01-28 05:19:00", tz='America/New_York') &
  mainroom_filt$date1min < as.POSIXct("2021-01-28 06:44:00", tz='America/New_York'), ])

mainroom_filt <- set_NA(mainroom_filt, "2021-01-28 05:18:00", "2021-01-28 06:44:00")

# Cleaning sources 1/28
mainroom_filt <- set_NA(mainroom_filt, "2021-01-28 08:00:00", "2021-01-28 12:00:00")
mainroom_filt <- set_NA(mainroom_filt, "2021-01-28 14:00:00", "2021-01-28 15:00:00")
mainroom_filt <- set_NA(mainroom_filt, "2021-01-28 17:01:00", "2021-01-28 18:21:00")


mainroom_indoor_src <- complete(
  mainroom_indoor_src, 
  date1min = seq(min(mainroom_filt$date1min, na.rm=TRUE),
                 max(mainroom_filt$date1min, na.rm=TRUE), by = "min"))

plot_time_resolved(mainroom, TRUE)
plot_time_resolved(mainroom_filt, TRUE)
plot_time_resolved(mainroom_indoor_src, TRUE)

```
## Veterans

```{r, fig.height=10}

# Cleaning - 1/25
veterans_filt <- set_NA(veterans, "2021-01-25 10:14:00", "2021-01-25 10:36:00")

# Small particle sources - 1/25
veterans_indoor_src <- veterans_filt[
  veterans_filt$date1min > as.POSIXct("2021-01-25 12:07:00", tz='America/New_York') &
  veterans_filt$date1min < as.POSIXct("2021-01-25 14:02:00", tz='America/New_York'), ]

veterans_filt <- set_NA(veterans_filt, "2021-01-25 11:31:00", "2021-01-25 14:02:00")

veterans_indoor_src <- rbind(veterans_indoor_src, veterans_filt[
  veterans_filt$date1min > as.POSIXct("2021-01-25 17:17:00", tz='America/New_York') &
  veterans_filt$date1min < as.POSIXct("2021-01-25 18:33:00", tz='America/New_York'), ])

veterans_filt <- set_NA(veterans_filt, "2021-01-25 17:03:00", "2021-01-25 18:33:00")

# Small particle source - 1/27
veterans_indoor_src <- rbind(veterans_indoor_src, veterans_filt[
  veterans_filt$date1min > as.POSIXct("2021-01-27 06:57:00", tz='America/New_York') &
  veterans_filt$date1min < as.POSIXct("2021-01-27 09:30:00", tz='America/New_York'), ])

veterans_filt <- set_NA(veterans_filt, "2021-01-27 00:00:00", "2021-01-27 09:30:00")

# Small particle sources - 1/28
veterans_indoor_src <- rbind(veterans_indoor_src, veterans_filt[
  veterans_filt$date1min > as.POSIXct("2021-01-28 05:20:00", tz='America/New_York') &
  veterans_filt$date1min < as.POSIXct("2021-01-28 05:44:00", tz='America/New_York'), ])

veterans_filt <- set_NA(veterans_filt, "2021-01-28 05:19:00", "2021-01-28 05:44:00")

veterans_indoor_src <- rbind(veterans_indoor_src, veterans_filt[
  veterans_filt$date1min > as.POSIXct("2021-01-28 11:07:00", tz='America/New_York') &
  veterans_filt$date1min < as.POSIXct("2021-01-28 12:12:00", tz='America/New_York'), ])

veterans_filt <- set_NA(veterans_filt, "2021-01-28 11:06:00", "2021-01-28 12:12:00")

# Cleaning source - 1/28
veterans_filt <- set_NA(veterans_filt, "2021-01-28 17:22:00", "2021-01-28 17:58:00")


veterans_indoor_src <- complete(
  veterans_indoor_src, 
  date1min = seq(min(veterans_filt$date1min, na.rm=TRUE),
                 max(veterans_filt$date1min, na.rm=TRUE), by = "min"))


plot_time_resolved(veterans, temp=TRUE)
plot_time_resolved(veterans_filt, temp=TRUE)
plot_time_resolved(veterans_indoor_src, temp=TRUE)
```

## Water Department

```{r, fig.height=10}
# Small particle source - 1/7
waterdept_indoor_src <- waterdept_merged[
  waterdept_merged$date1min > as.POSIXct("2021-01-07 08:46:00", tz='America/New_York') &
  waterdept_merged$date1min < as.POSIXct("2021-01-07 10:14:00", tz='America/New_York'), ]

waterdept_filt <- set_NA(waterdept_merged, "2021-01-07 08:46:00", "2021-01-07 10:14:00")

# Cleaning source - 1/8
waterdept_filt <- set_NA(waterdept_merged, "2021-01-08 09:08:00", "2021-01-08 12:43:00")

# Small particle source - 1/9
waterdept_indoor_src <- rbind(waterdept_indoor_src, waterdept_filt[
  waterdept_filt$date1min > as.POSIXct("2021-01-09 10:49:00", tz='America/New_York') &
  waterdept_filt$date1min < as.POSIXct("2021-01-09 15:22:00", tz='America/New_York'), ])

waterdept_filt <- set_NA(waterdept_filt, "2021-01-09 10:14:00", "2021-01-09 15:22:00")

#Extraneous bad data points - 1/12
waterdept_filt <- set_NA(waterdept_filt, "2021-01-12 08:30:00", "2021-01-12 08:32:00")
waterdept_filt <- set_NA(waterdept_filt, "2021-01-12 09:55:00", "2021-01-12 09:57:00")

# Cleaning source - 1/13
waterdept_indoor_src <- rbind(waterdept_indoor_src, waterdept_filt[
  waterdept_filt$date1min > as.POSIXct("2021-01-13 06:39:00", tz='America/New_York') &
  waterdept_filt$date1min < as.POSIXct("2021-01-13 07:40:00", tz='America/New_York'), ])

waterdept_filt <- set_NA(waterdept_filt, "2021-01-13 06:39:00", "2021-01-13 07:40:00")

# Fine particle source - 1/13
waterdept_indoor_src <- rbind(waterdept_indoor_src, waterdept_filt[
  waterdept_filt$date1min > as.POSIXct("2021-01-13 08:26:00", tz='America/New_York') &
  waterdept_filt$date1min < as.POSIXct("2021-01-13 09:19:00", tz='America/New_York'), ])

waterdept_filt <- set_NA(waterdept_filt, "2021-01-13 08:18:00", "2021-01-13 09:19:00")

waterdept_indoor_src <- complete(
  waterdept_indoor_src, 
  date1min = seq(min(waterdept_filt$date1min, na.rm=TRUE),
                 max(waterdept_filt$date1min, na.rm=TRUE), by = "min"))

plot_time_resolved(waterdept_merged, TRUE)
plot_time_resolved(waterdept_indoor_src, TRUE)
plot_time_resolved(waterdept_filt, TRUE)
```

```{r}
filtered <- list(
  "CH_engineering_filt" = engineering_filt, 
  "CH_waterdept_filt" = waterdept_filt, 
  "CH_mainroom_filt" = mainroom_filt, 
  "CH_auditor_filt" = auditor_filt, 
  "CH_veterans_filt" = veterans_filt, 
  "CH_clerk_filt" = clerk_filt)

indoor_src <- list(
  "CH_engineering_indoor_src" = engineering_indoor_src, 
  "CH_waterdept_indoor_src" = waterdept_indoor_src, 
  "CH_mainroom_indoor_src" = mainroom_indoor_src, 
  "CH_auditor_indoor_src" = auditor_indoor_src, 
  "CH_veterans_indoor_src" = veterans_indoor_src, 
  "CH_clerk_indoor_src" = clerk_indoor_src)
```

```{r}
mapply(
  write.table, #apply function write table
  x=filtered, file=paste("../data/filtered", paste(names(filtered), "csv", sep="."), sep="/"), #for each dataframe, use its name to make a csv of it
  MoreArgs=list(row.names=FALSE, sep=",")
)
```

```{r}
mapply(
  write.table, #apply function write table
  x=indoor_src, file=paste("../data/indoor_src", paste(names(indoor_src), "csv", sep="."), sep="/"), #for each dataframe, use its name to make a csv of it
  MoreArgs=list(row.names=FALSE, sep=",")
)
```




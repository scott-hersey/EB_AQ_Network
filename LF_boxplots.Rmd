---
title: "hepa_impact"
author: "Megan Ku"
date: "3/4/2021"
output: html_document
---

```{r setup, warning= FALSE, error = FALSE}
library(lubridate) #date and time functions 
library(data.table) #to use the data.table variable type
library(dplyr) #this library allows you to use the %>% operator
library(tidyr) #this library lets you use the complete function to account for time syncing
library(openair) #for plotting and analysis
library(stringr)
library(readr) #read .csv files
library(ggplot2) #plotting
source("filter_data.R")
source("make_boxplots.R")
```

# HEPA Impact Plots for Little Folks

This notebook focuses on creating visuals to highlight the impact of HEPA
purifiers on particle concentration in classrooms.

## Setup

## Import Data

The variables of interest to us are the following:

- concent_ratio: indoor/outdoor concentration ratio for CPC data as calculated 
in hepa_main.Rmd
- concent_1.indoor/.outdoor: used to calculate concent_ratio
- bin0: smallest particle size from Mod-PM
- neph_bin0: used to calculate pm1, pm2.5, and pm10 (nephlometer)
- pm1, pm2.5, pm10: regulated particle sizes from EPA
- HEPA_on: purifier active state

We can ignore parsing failures for columns we won't be utilizing. We'll combine 
the imported data frames into one list.

```{r}
admin_ratio <- import_ratio_data('./data/LF_admin_filt.csv')
class1_ratio <- import_ratio_data('./data/LF_class1_filt.csv')
class2_ratio <- import_ratio_data('./data/LF_class2_filt.csv', TRUE)
class3_ratio <- import_ratio_data('./data/LF_class3_filt.csv')
class4_ratio <- import_ratio_data('./data/LF_class4_filt.csv', TRUE)
```

Looking at hepa_main.Rmd, it seems that it's more useful to keep all structures
as a list. That way, if we need to apply the same function to each data frame, 
we can do so with a function.

```{r}
CPC_ratio_list <- list(
  "class2" = class2_ratio,
  "class4" = class4_ratio
  )

# PM-only data
PM_ratio_list <- list(
  "admin" = admin_ratio,
  "class1" = class1_ratio,
  "class3" = class3_ratio
)
```

To make the data frame more manageable, we'll only select specific columns. We 
will also calculate indoor/outdoor ratios for all particle sizes.


```{r}
CPC_focus_list <- lapply(CPC_ratio_list,  simplify_ratio_data, is_CPC=TRUE)
PM_focus_list <- lapply(PM_ratio_list,  simplify_ratio_data) 
```

## Pre-Processing

### Tidy dataset


It is good practice that a dataset be *tidy*. We will make this data tidier by
transposing the columns.

```{r}
CPC_focus_tidy <- lapply(CPC_focus_list,  function(x) tidy_data(x))
PM_focus_tidy <- lapply(PM_focus_list, function(x) tidy_data(x))
```

### Identify pre/post HEPA purifiers

Let's filter the data for the times before and after the HEPA purifiers were
installed.

```{r}
CPC_tidy_split <- vector(mode = "list", length = 1)
PM_tidy_split <- vector(mode = "list", length = 1)

# Class 2
CPC_tidy_split$class2.post <- CPC_focus_tidy$class2 %>%
`filter`(HEPA_on == 1)

CPC_tidy_split$class2.pre <- CPC_focus_tidy$class2 %>%
  filter(HEPA_on == 0)

# Class 4
CPC_tidy_split$class4.post <- CPC_focus_tidy$class4 %>%
  filter(HEPA_on == 1)

CPC_tidy_split$class4.pre <- CPC_focus_tidy$class4 %>%
  filter(HEPA_on == 0)

# Admin
PM_tidy_split$admin.post <- PM_focus_tidy$admin %>%
  filter(HEPA_on == 1)

PM_tidy_split$admin.pre <- PM_focus_tidy$admin %>%
  filter(HEPA_on == 0)

# Class 1
PM_tidy_split$class1.post <- PM_focus_tidy$class1 %>%
  filter(HEPA_on == 1)

PM_tidy_split$class1.pre <- PM_focus_tidy$class1 %>%
  filter(HEPA_on == 0)

# Class 3
PM_tidy_split$class3.post <- PM_focus_tidy$class3 %>%
  filter(HEPA_on == 1)

PM_tidy_split$class3.pre <- PM_focus_tidy$class3 %>%
  filter(HEPA_on == 0)

# Remove placeholders
CPC_tidy_split <- CPC_tidy_split[lengths(CPC_tidy_split) != 0]
PM_tidy_split <- PM_tidy_split[lengths(PM_tidy_split) != 0]
```

Let's calculate the mean concentration ratios before and after the HEPA 
installation, as well as the standard deviations. We'll store this in another 
dataset, which we will also tidy up.

```{r}
names = c("class2", "class4", "class2", "class4")

is_HEPA = c("pre", "pre", "post", "post")

CPC_mean_ratios <- lapply(CPC_tidy_split, calculate_mean_ratio, TRUE) %>%
  bind_rows()

# Add labels to dataframe
CPC_mean_ratios <- cbind(name = names, CPC_mean_ratios)
CPC_mean_ratios <- cbind(CPC_mean_ratios, is_HEPA)

# Pivot wider for easier readability upon export
CPC_mean_ratios <- CPC_mean_ratios %>%
  pivot_wider(names_from = is_HEPA, names_sep = '.', values_from = -name) %>%
  mutate(conc_reduction = (conc.pre - conc.post)/conc.pre,
         bin0_reduction = (bin0.pre - bin0.post)/bin0.pre,
         neph_bin0_reduction = (neph_bin0.pre - neph_bin0.post)/neph_bin0.pre,
         pm1_reduction = (pm1.pre - pm1.post)/pm1.pre,
         pm25_reduction = (pm25.pre - pm25.post)/pm25.pre,
         pm10_reduction = (pm10.pre - pm10.post)/pm10.pre)

CPC_mean_ratios
```

```{r}
PM_mean_ratios <- lapply(PM_tidy_split, calculate_mean_ratio) %>%
  bind_rows()

names = c("admin", "class1", "class3")
is_HEPA = c("pre", "pre", "pre", "post", "post", "post")

PM_mean_ratios <- cbind(name = names, PM_mean_ratios)
PM_mean_ratios <- cbind(PM_mean_ratios, is_HEPA)

PM_mean_ratios <- PM_mean_ratios %>%
  pivot_wider(names_from = is_HEPA, names_sep = '.', values_from = -name) %>%
  mutate(bin0_reduction = (bin0.pre - bin0.post)/bin0.pre,
         neph_bin0_reduction = (neph_bin0.pre - neph_bin0.post)/neph_bin0.pre,
         pm1_reduction = (pm1.pre - pm1.post)/pm1.pre,
         pm25_reduction = (pm25.pre - pm25.post)/pm25.pre,
         pm10_reduction = (pm10.pre - pm10.post)/pm10.pre)

PM_mean_ratios
```
Here, we'll export the data to a .csv file for further data analysis.

```{r}
write.table(CPC_mean_ratios, "LF_mean_ratios.csv", append = FALSE, sep = ",", dec = ".",
            row.names = FALSE, col.names = TRUE)
write.table(PM_mean_ratios, "LF_pm_mean_ratios.csv", append = FALSE, sep = ",", dec = ".",
            row.names = FALSE, col.names = TRUE)
```


## Plot Concentration Changes

Let's investigate the data by using boxplots. Before we do that, though, we 
must distinguish which data is before and after the purifier installation.

```{r}
# Prep for boxplot
class2_boxplot_ratios <- CPC_focus_tidy$class2 %>%
  mutate(HEPA_on = as.character(HEPA_on)) %>%
  filter(source == "concent_ratio" | source == "bin0_ratio"| 
           source == "neph_bin0_ratio" | source == "pm1_ratio" | 
           source == "pm25_ratio" | source ==  "pm10_ratio")

class2_boxplot_ratios$source <- factor(
  class2_boxplot_ratios$source, 
  levels=c("concent_ratio", "bin0_ratio", "neph_bin0_ratio", 
                        "pm1_ratio", "pm25_ratio", "pm10_ratio"))


class4_boxplot_ratios <- CPC_focus_tidy$class4 %>%
  mutate(HEPA_on = as.character(HEPA_on)) %>%
  filter(source == "concent_ratio" | source == "bin0_ratio"| 
           source == "neph_bin0_ratio" | source == "pm1_ratio" | 
           source == "pm25_ratio" | source ==  "pm10_ratio")

class4_boxplot_ratios$source <- factor(
  class4_boxplot_ratios$source , 
  levels=c("concent_ratio", "bin0_ratio", "neph_bin0_ratio", 
                        "pm1_ratio", "pm25_ratio", "pm10_ratio"))
```

We will use the built-in ggplot2 boxplot and adjust the visuals to our needs.

### Class 2

```{r, fig.height=5}
# Nice labels for facet_grid
source.labs <- c("CPC Conc.", "Bin 0", "Neph. Bin 0", "PM1", "PM2.5", "PM10")
names(source.labs) <- c("concent_ratio", "bin0_ratio", "neph_bin0_ratio", 
                        "pm1_ratio", "pm25_ratio", "pm10_ratio")

class2_boxplot <- ggplot(data=class2_boxplot_ratios, aes(x=source, y=ratio, fill=HEPA_on)) +
  geom_boxplot() +
  
  # separate visually by measurement and move labels to bottom of boxplot
  facet_grid(. ~ source, scales='free_x',
             labeller = labeller(source = source.labs),
             switch = "x") +
  
  # label graph
  labs(title="Effect of HEPA Purifiers on Particle Ratios",
       subtitle= "Little Folks: Class 2",
       x="Particle Ratio Type",
       y="Indoor/Outdoor Ratio") +

  # Change legend and use blue theme
  scale_fill_brewer(name = "Sensor Measurements",
                    labels = c("Initial Recording", 
                                 "After HEPA Installation"),
                    palette="Blues") +
  

  # Clean up axes
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()) +

  # Set limits  
  ylim(0,1)
class2_boxplot

# Save image
ggsave("LF_class2_box.png")
```
### Class 4

```{r, fig.height=5}
class4_boxplot <- ggplot(data=class4_boxplot_ratios, aes(x=source, y=ratio, fill=HEPA_on)) +
  geom_boxplot() +
  
  # separate visually by measurement and move labels to bottom of boxplot
  facet_grid(. ~ source, scales='free_x',
             labeller = labeller(source = source.labs),
             switch = "x") +
  
  # label graph
  labs(title="Effect of HEPA Purifiers on Particle Ratios",
       subtitle= "Little Folks: Class 4",
       x="Particle Ratio Type",
       y="Indoor/Outdoor Ratio") +

  # Change legend and use blue theme
  scale_fill_brewer(name = "Sensor Measurements",
                    labels = c("Initial Recording", 
                                 "After HEPA Installation"),
                    palette="Blues") +
  

  # Clean up axes
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()) +

  # Set limits  
  ylim(0,1)

class4_boxplot

# Save image
ggsave("LF_class4_box.png")
```


Let's do the same for the data that was only Modulair-PM-sourced.

```{r, fig.height=5}
# Combine Admin data
admin_boxplot_ratios <- PM_focus_tidy$admin %>%
  mutate(HEPA_on = as.character(HEPA_on)) %>%
  filter(source == "bin0_ratio"| source == "neph_bin0_ratio" | source == "pm1_ratio" | source == "pm25_ratio" | source ==  "pm10_ratio")

admin_boxplot_ratios$source <- factor(admin_boxplot_ratios$source , levels=c("bin0_ratio", "neph_bin0_ratio", 
                        "pm1_ratio", "pm25_ratio", "pm10_ratio"))


class1_boxplot_ratios <- PM_focus_tidy$class1 %>%
  mutate(HEPA_on = as.character(HEPA_on)) %>%
  filter(source == "bin0_ratio"| source == "neph_bin0_ratio" | source == "pm1_ratio" | source == "pm25_ratio" | source ==  "pm10_ratio")

class1_boxplot_ratios$source <- factor(class1_boxplot_ratios$source , levels=c("bin0_ratio", "neph_bin0_ratio", 
                        "pm1_ratio", "pm25_ratio", "pm10_ratio"))


class3_boxplot_ratios <- PM_focus_tidy$class3 %>%
  mutate(HEPA_on = as.character(HEPA_on)) %>%
  filter(source == "bin0_ratio"| source == "neph_bin0_ratio" | 
           source == "pm1_ratio" | source == "pm25_ratio" | source ==  "pm10_ratio")

class3_boxplot_ratios$source <- factor(
  class3_boxplot_ratios$source , levels=c("bin0_ratio", "neph_bin0_ratio", 
                        "pm1_ratio", "pm25_ratio", "pm10_ratio"))
```

```{r, fig.height=5}
source.labs <- c("Bin 0", "Neph. Bin 0", "PM1", "PM2.5", "PM10")
names(source.labs) <- c("bin0_ratio", "neph_bin0_ratio", 
                        "pm1_ratio", "pm25_ratio", "pm10_ratio")

admin_boxplot <- ggplot(data=admin_boxplot_ratios, aes(x=source, y=ratio, fill=HEPA_on)) +
  geom_boxplot() +
  
  facet_grid(. ~ source, scales='free_x',
             labeller = labeller(source = source.labs),
             switch = "x") +
  
  
  labs(title="Effect of HEPA Purifiers on Particle Ratios",
       subtitle= "Little Folks: Admin Room",
       x="Particle Ratio Type",
       y="Indoor/Outdoor Ratio") +

  
  scale_fill_brewer(name = "Sensor Measurements",
                    labels = c("Initial Recording", 
                                 "After HEPA Installation"),
                    palette="Blues") +
  

  
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()) +

  ylim(0,1)

admin_boxplot
ggsave("LF_admin_box.png")
```

```{r, fig.height=5}
class1_boxplot <- ggplot(data=class1_boxplot_ratios, aes(x=source, y=ratio, fill=HEPA_on)) +
  geom_boxplot() +
  
  facet_grid(. ~ source, scales='free_x',
             labeller = labeller(source = source.labs),
             switch = "x") +
  
  
  labs(title="Effect of HEPA Purifiers on Particle Ratios",
       subtitle= "Little Folks: Class 1",
       x="Particle Ratio Type",
       y="Indoor/Outdoor Ratio") +

  
  scale_fill_brewer(name = "Sensor Measurements",
                    labels = c("Initial Recording", 
                                 "After HEPA Installation"),
                    palette="Blues") +
  

  
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()) +

  ylim(0,1)
class1_boxplot
ggsave("LF_class1_box.png")
```


```{r, fig.height=5}
class3_boxplot <- ggplot(data=class3_boxplot_ratios, aes(x=source, y=ratio, fill=HEPA_on)) +
  geom_boxplot() +
  
  facet_grid(. ~ source, scales='free_x',
             labeller = labeller(source = source.labs),
             switch = "x") +
  
  
  labs(title="Effect of HEPA Purifiers on Particle Ratios",
       subtitle= "Little Folks: Class 3",
       x="Particle Ratio Type",
       y="Indoor/Outdoor Ratio") +

  
  scale_fill_brewer(name = "Sensor Measurements",
                    labels = c("Initial Recording", 
                                 "After HEPA Installation"),
                    palette="Blues") +
  

  
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()) +

  ylim(0,1)

class3_boxplot
ggsave("LF_class3_box.png")
```

```{r}
admin_quartile <- ggplot_build(admin_boxplot)$data[[1]] %>%
  select(-outliers)
class1_quartile <- ggplot_build(class1_boxplot)$data[[1]] %>%
  select(-outliers)
class2_quartile <- ggplot_build(class2_boxplot)$data[[1]] %>%
  select(-outliers)
class3_quartile <- ggplot_build(class3_boxplot)$data[[1]] %>%
  select(-outliers)
class4_quartile <- ggplot_build(class4_boxplot)$data[[1]] %>%
  select(-outliers)

LF_med <- list('LF_admin_quartile' = admin_quartile, 
               'LF_class1_quartile'= class1_quartile, 
               'LF_class2_quartile'= class2_quartile, 
               'LF_class3_quartile'= class3_quartile,
               'LF_class4_quartile'= class4_quartile)
```
```{r}
mapply(
  write.table, #apply function write table
  x=LF_med, file=paste("data", paste(names(LF_med), "csv", sep="."), sep="/"), #for each dataframe, use its name to make a csv of it
  MoreArgs=list(row.names=FALSE, sep=",")
)
```


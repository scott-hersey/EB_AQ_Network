---
title: "hepa_impact"
author: "Megan Ku"
date: "3/4/2021"
output: html_document
---

```{r setup, warning= FALSE, error = FALSE}
library(lubridate) #date and time functions 
library(data.table) #to use the data.table variable type
library(dplyr) #this library allows you to use the %>% operator
library(tidyr) #this library lets you use the complete function to account for time syncing
library(openair) #for plotting and analysis
library(stringr)
library(readr) #read .csv files
library(ggplot2) #plotting
```

# HEPA Impact Plots for Revere City Hall and Revere VFW

This notebook focuses on creating visuals to highlight the impact of HEPA
purifiers on particle concentration in classrooms.

## Setup
In hepa_main.Rmd, un-comment the code in the chunk at line 486 to download the 
processed data as .csv files. This will be our starting point.


## Import Data

We will start by importing the datasets here. We need to manually set 
the values as doubles.

```{r}
LF_admin_ratio <- read_csv('LF_admin_ratio.csv', col_types = cols(
  bin0.indoor = col_double(),
  bin0.outdoor = col_double(),
  neph_bin0.indoor = col_double(),
  neph_bin0.outdoor = col_double(),
  pm1_ratio = col_double(),
  pm1.indoor = col_double(),
  pm1.outdoor = col_double(),
  pm25.indoor = col_double(),
  pm25.outdoor = col_double(),
  pm10.indoor = col_double(),
  pm10.outdoor = col_double()
))
LF_class1_ratio <- read_csv('LF_class1_ratio.csv', col_types = cols(
  bin0.indoor = col_double(),
  bin0.outdoor = col_double(),
  neph_bin0.indoor = col_double(),
  neph_bin0.outdoor = col_double(),
  pm1_ratio = col_double(),
  pm1.indoor = col_double(),
  pm1.outdoor = col_double(),
  pm25.indoor = col_double(),
  pm25.outdoor = col_double(),
  pm10.indoor = col_double(),
  pm10.outdoor = col_double()
))
LF_class2_ratio <- read_csv('LF_class2_ratio.csv', col_types = cols(
  concent_ratio = col_double(),
  concent_1.indoor = col_double(),
  concent_1.outdoor = col_double(),
  bin0.indoor = col_double(),
  bin0.outdoor = col_double(),
  neph_bin0.indoor = col_double(),
  neph_bin0.outdoor = col_double(),
  pm1_ratio = col_double(),
  pm1.indoor = col_double(),
  pm1.outdoor = col_double(),
  pm25.indoor = col_double(),
  pm25.outdoor = col_double(),
  pm10.indoor = col_double(),
  pm10.outdoor = col_double()
))
LF_class3_ratio <- read_csv('LF_class3_ratio.csv', col_types = cols(
  bin0.indoor = col_double(),
  bin0.outdoor = col_double(),
  neph_bin0.indoor = col_double(),
  neph_bin0.outdoor = col_double(),
  pm1_ratio = col_double(),
  pm1.indoor = col_double(),
  pm1.outdoor = col_double(),
  pm25.indoor = col_double(),
  pm25.outdoor = col_double(),
  pm10.indoor = col_double(),
  pm10.outdoor = col_double()
))
LF_class4_ratio <- read_csv('LF_class4_ratio.csv', col_types = cols(
  concent_ratio = col_double(),
  concent_1.indoor = col_double(),
  concent_1.outdoor = col_double(),
  bin0.indoor = col_double(),
  bin0.outdoor = col_double(),
  neph_bin0.indoor = col_double(),
  neph_bin0.outdoor = col_double(),
  pm1_ratio = col_double(),
  pm1.indoor = col_double(),
  pm1.outdoor = col_double(),
  pm25.indoor = col_double(),
  pm25.outdoor = col_double(),
  pm10.indoor = col_double(),
  pm10.outdoor = col_double()
))

# col_types = cols(
#   concent_ratio = col_double(),
#   concent_1.indoor = col_double(),
#   concent_1.outdoor = col_double(),
#   bin0_ratio = col_double(),
#   bin0.indoor = col_double(),
#   bin0.outdoor = col_double(),
#   neph_bin0_ratio = col_double(),
#   neph_bin0.indoor = col_double(),
#   neph_bin0.outdoor = col_double(),
#   pm1_ratio = col_double(),
#   pm1.indoor = col_double(),
#   pm1.outdoor = col_double(),
#   pm25_ratio = col_double(),
#   pm25.indoor = col_double(),
#   pm25.outdoor = col_double(),
#   pm10_ratio = col_double(),
#   pm10.indoor = col_double(),
#   pm10.outdoor = col_double()
# )
```

Looking at hepa_main.Rmd, it seems that it's more useful to keep all structures
as a list. That way, if we need to apply the same function to each data frame, 
we can do so with a function.

```{r}
LF_ratio_list <- list(
  "class2" = LF_class2_ratio,
  "class4" = LF_class4_ratio
  )

# PM-only data
LF_pm_ratio_list <- list(
  "admin" = LF_admin_ratio,
  "class1" = LF_class1_ratio,
  "class3" = LF_class3_ratio
)
```

```{r}
LF_ratio_list
LF_pm_ratio_list
```



To make the data frame more manageable, we'll only select specific columns. We 
will also calculate indoor/outdoor ratios for all particle sizes.


```{r}
simplify_ratio_data <- function(room) {
  room <- room %>%
    # Add/delete relevant columns here
    mutate(bin0_ratio = bin0.indoor/bin0.outdoor) %>%
    mutate(neph_bin0_ratio = neph_bin0.indoor/neph_bin0.outdoor) %>%
    mutate(pm25_ratio = pm25.indoor/pm25.outdoor) %>%
    mutate(pm10_ratio = pm10.indoor/pm10.outdoor) %>%
    select(date1min, 
           concent_ratio,
           concent_1.indoor,
           concent_1.outdoor,
           bin0_ratio,
           bin0.indoor,
           bin0.outdoor,
           neph_bin0_ratio,
           neph_bin0.indoor,
           neph_bin0.outdoor,
           pm1_ratio,
           pm1.indoor,
           pm1.outdoor,
           pm25_ratio,
           pm25.indoor,
           pm25.outdoor,
           pm10_ratio,
           pm10.indoor,
           pm10.outdoor)
    
  return(room)
}

simplify_pm_ratio_data <- function(room) {
  room <- room %>%
    # Add/delete relevant columns here
    rename(date1min = date)%>%
    mutate(bin0_ratio = bin0.indoor/bin0.outdoor) %>%
    mutate(neph_bin0_ratio = neph_bin0.indoor/neph_bin0.outdoor) %>%
    mutate(pm25_ratio = pm25.indoor/pm25.outdoor) %>%
    mutate(pm10_ratio = pm10.indoor/pm10.outdoor) %>%
    select(date1min,
            bin0_ratio,
            bin0.indoor,
            bin0.outdoor,
            neph_bin0_ratio,
            neph_bin0.indoor,
            neph_bin0.outdoor,
            pm1_ratio,
            pm1.indoor,
            pm1.outdoor,
            pm25_ratio,
            pm25.indoor,
            pm25.outdoor,
            pm10_ratio,
            pm10.indoor,
            pm10.outdoor)
  return(room)
}

LF_ratio_list <- lapply(LF_ratio_list,  function(x) simplify_ratio_data(x)) # Only save columns of importance 

LF_pm_ratio_list <- lapply(LF_pm_ratio_list,  function(x) simplify_pm_ratio_data(x)) # Only save columns of importance 

```

Since times were imported as UTC, the below code block switches them back to
Eastern.

```{r}
time_to_eastern <- function(room) {
  tz(room$date1min) <- "America/New_York"
  return(room)
}

LF_ratio_list <- lapply(LF_ratio_list,  function(x) time_to_eastern(x)) # Fix time zone
LF_pm_ratio_list <- lapply(LF_pm_ratio_list,  function(x) time_to_eastern(x)) # Fix time zone

```

```{r}
LF_ratio_list$class2$concent_1.indoor[LF_ratio_list$class2$concent_ratio <= 0.0001] <- NA
LF_ratio_list$class2$concent_1.outdoor[LF_ratio_list$class2$concent_ratio <= 0.0001] <- NA
LF_ratio_list$class2$concent_ratio[LF_ratio_list$class2$concent_ratio <= 0.0001] <- NA

LF_ratio_list$class4$concent_1.indoor[LF_ratio_list$class4$concent_ratio <= 0.0001] <- NA
LF_ratio_list$class4$concent_1.outdoor[LF_ratio_list$class4$concent_ratio <= 0.0001] <- NA
LF_ratio_list$class4$concent_ratio[LF_ratio_list$class4$concent_ratio <= 0.0001] <- NA
```


It is good practice that a dataset be *tidy*. We will make this data tidier by
transposing the columns.

```{r}
tidy_data <- function(room) {
  room <- room %>%
    pivot_longer(-date1min, names_to = "source", values_to = "ratio")
}

LF_ratio_list <- lapply(LF_ratio_list,  function(x) tidy_data(x))
LF_pm_ratio_list <- lapply(LF_pm_ratio_list,  function(x) tidy_data(x))
```

We will now filter the data for work hours to focus on the impact the purifiers
have on the people in these buildings. For Little Folks, let's say that 
normal work hours are M-F from 7am to 4pm ET.

```{r}
filter_workday <- function(room) {
  room <- room %>%
    filter(hour(date1min) >= 7 & hour(date1min) <= 16) %>%
    filter(wday(date1min) %in% 2:6)
}

LF_ratio_list <- lapply(LF_ratio_list,  function(x) filter_workday(x))
LF_pm_ratio_list <- lapply(LF_pm_ratio_list,  function(x) filter_workday(x))
```

Let's filter the data for the times before and after the HEPA purifiers were
installed. Dataframes with '_HEPA' indicate data taken post HEPA purifier 
installation.

```{r}
# Class 2
LF_ratio_list$class2_HEPA <- LF_ratio_list$class2 %>%
  filter(date1min > as.POSIXct("2021-03-31 06:15:00", tz='America/New_York'), 
         date1min < as.POSIXct("2021-04-07 07:08:00", tz='America/New_York'))

LF_ratio_list$class2 <- LF_ratio_list$class2 %>%
  filter(date1min > as.POSIXct("2021-03-24 09:00:00", tz='America/New_York'), 
         date1min < as.POSIXct("2021-03-31 06:15:00", tz='America/New_York'))

# Class 4
LF_ratio_list$class4_HEPA <- LF_ratio_list$class4 %>%
  filter(date1min > as.POSIXct("2021-03-31 06:30:00", tz='America/New_York'), 
         date1min < as.POSIXct("2021-04-07 07:21:00", tz='America/New_York'))

LF_ratio_list$class4 <- LF_ratio_list$class4 %>%
  filter(date1min > as.POSIXct("2021-03-24 09:28:00", tz='America/New_York'), 
         date1min < as.POSIXct("2021-03-31 06:30:00", tz='America/New_York'))

# Admin
LF_pm_ratio_list$admin_HEPA <- LF_pm_ratio_list$admin %>%
  filter(date1min > as.POSIXct("2021-03-31 06:45:00", tz='America/New_York'), 
         date1min < as.POSIXct("2021-04-07 07:29:00", tz='America/New_York'))

LF_pm_ratio_list$admin <- LF_pm_ratio_list$admin %>%
  filter(date1min > as.POSIXct("2021-03-24 09:30:00", tz='America/New_York'), 
         date1min < as.POSIXct("2021-03-31 06:45:00", tz='America/New_York'))

# Class 1
LF_pm_ratio_list$class1_HEPA <- LF_pm_ratio_list$class1 %>%
  filter(date1min > as.POSIXct("2021-03-31 06:22:00", tz='America/New_York'), 
         date1min < as.POSIXct("2021-04-07 07:29:00", tz='America/New_York'))

LF_pm_ratio_list$class1 <- LF_pm_ratio_list$class1 %>%
  filter(date1min > as.POSIXct("2021-03-24 09:15:00", tz='America/New_York'), 
         date1min < as.POSIXct("2021-03-31 06:22:00", tz='America/New_York'))

# Class 3
LF_pm_ratio_list$class3_HEPA <- LF_pm_ratio_list$class3 %>%
  filter(date1min > as.POSIXct("2021-03-31 06:36:00", tz='America/New_York'), 
         date1min < as.POSIXct("2021-04-07 07:27:00", tz='America/New_York'))

LF_pm_ratio_list$class3 <- LF_pm_ratio_list$class3 %>%
  filter(date1min > as.POSIXct("2021-03-24 09:34:00", tz='America/New_York'), 
         date1min < as.POSIXct("2021-03-31 06:36:00", tz='America/New_York'))
```

```{r}
LF_ratio_list
LF_pm_ratio_list
```


Let's calculate the mean concentration ratios before and after the HEPA 
installation, as well as the standard deviations. We'll store this in another 
dataset, which we will also tidy up.

```{r}
names = c("class2", "class4", "class2", "class4")

is_HEPA = c("pre", "pre", "post", "post")

calculate_mean_ratio <- function(room) {
  
  # Calculate mean conc before and after for indoor, outdoor, and ratio
  # Calculate standard deviations for all as well
  conc <- room %>%
    filter(source=="concent_ratio") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(conc = "mean(ratio, na.rm = TRUE)")
  conc_sd <- room %>%
    filter(source=="concent_ratio") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(conc_sd = "sd(ratio, na.rm = TRUE)")
  conc.indoor <- room %>%
    filter(source=="concent_1.indoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(conc.indoor = "mean(ratio, na.rm = TRUE)")
  conc_sd.indoor <- room %>%
    filter(source=="concent_1.indoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(conc_sd.indoor = "sd(ratio, na.rm = TRUE)")  
  conc.outdoor <- room %>%
    filter(source=="concent_1.outdoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(conc.outdoor = "mean(ratio, na.rm = TRUE)")
  conc_sd.outdoor <- room %>%
    filter(source=="concent_1.outdoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(conc_sd.outdoor = "sd(ratio, na.rm = TRUE)")
  
  
  bin0 <- room %>%
    filter(source=="bin0_ratio") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(bin0 = "mean(ratio, na.rm = TRUE)")
  bin0_sd <- room %>%
    filter(source=="bin0_ratio") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(bin0_sd = "sd(ratio, na.rm = TRUE)")
  bin0.indoor <- room %>%
    filter(source=="bin0.indoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(bin0.indoor = "mean(ratio, na.rm = TRUE)")
  bin0_sd.indoor <- room %>%
    filter(source=="bin0.indoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(bin0_sd.indoor = "sd(ratio, na.rm = TRUE)")
    bin0.outdoor <- room %>%
    filter(source=="bin0.outdoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(bin0.outdoor = "mean(ratio, na.rm = TRUE)")
  bin0_sd.outdoor <- room %>%
    filter(source=="bin0.outdoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(bin0_sd.outdoor = "sd(ratio, na.rm = TRUE)")
  
  neph_bin0 <- room %>%
    filter(source=="neph_bin0_ratio") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(neph_bin0 = "mean(ratio, na.rm = TRUE)")
  neph_bin0_sd <- room %>%
    filter(source=="neph_bin0_ratio") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(neph_bin0_sd = "sd(ratio, na.rm = TRUE)")
  neph_bin0.indoor <- room %>%
    filter(source=="neph_bin0.indoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(neph_bin0.indoor = "mean(ratio, na.rm = TRUE)")
  neph_bin0_sd.indoor <- room %>%
    filter(source=="neph_bin0.indoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(neph_bin0_sd.indoor = "sd(ratio, na.rm = TRUE)")
  neph_bin0.outdoor <- room %>%
    filter(source=="neph_bin0.outdoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(neph_bin0.outdoor = "mean(ratio, na.rm = TRUE)")
  neph_bin0_sd.outdoor <- room %>%
    filter(source=="neph_bin0.outdoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(neph_bin0_sd.outdoor = "sd(ratio, na.rm = TRUE)")
  
  
  pm1 <- room %>%
    filter(source=="pm1_ratio") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(pm1 = "mean(ratio, na.rm = TRUE)")
  pm1_sd <- room %>%
    filter(source=="pm1_ratio") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(pm1_sd = "sd(ratio, na.rm = TRUE)")
  pm1.indoor <- room %>%
    filter(source=="pm1.indoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(pm1.indoor = "mean(ratio, na.rm = TRUE)")
  pm1_sd.indoor <- room %>%
    filter(source=="pm1.indoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(pm1_sd.indoor = "sd(ratio, na.rm = TRUE)")
  pm1.outdoor <- room %>%
    filter(source=="pm1.outdoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(pm1.outdoor = "mean(ratio, na.rm = TRUE)")
  pm1_sd.outdoor <- room %>%
    filter(source=="pm1.outdoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(pm1_sd.outdoor = "sd(ratio, na.rm = TRUE)")
  
  
  pm25 <- room %>%
    filter(source=="pm25_ratio") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(pm25 = "mean(ratio, na.rm = TRUE)")
  pm25_sd <- room %>%
    filter(source=="pm25_ratio") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(pm25_sd = "sd(ratio, na.rm = TRUE)")
  pm25.indoor <- room %>%
    filter(source=="pm25.indoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(pm25.indoor = "mean(ratio, na.rm = TRUE)")
  pm25_sd.indoor <- room %>%
    filter(source=="pm25.indoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(pm25_sd.indoor = "sd(ratio, na.rm = TRUE)")
  pm25.outdoor <- room %>%
    filter(source=="pm25.outdoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(pm25.outdoor = "mean(ratio, na.rm = TRUE)")
  pm25_sd.outdoor <- room %>%
    filter(source=="pm25.outdoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(pm25_sd.outdoor = "sd(ratio, na.rm = TRUE)")
  

  pm10 <- room %>%
    filter(source=="pm10_ratio") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(pm10 = "mean(ratio, na.rm = TRUE)")
  pm10_sd <- room %>%
    filter(source=="pm10_ratio") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(pm10_sd = "sd(ratio, na.rm = TRUE)")
  pm10.indoor <- room %>%
    filter(source=="pm10.indoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(pm10.indoor = "mean(ratio, na.rm = TRUE)")
  pm10_sd.indoor <- room %>%
    filter(source=="pm10.indoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(pm10_sd.indoor = "sd(ratio, na.rm = TRUE)")
  pm10.outdoor <- room %>%
    filter(source=="pm10.outdoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(pm10.outdoor = "mean(ratio, na.rm = TRUE)")
  pm10_sd.outdoor <- room %>%
    filter(source=="pm10.outdoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(pm10_sd.outdoor = "sd(ratio, na.rm = TRUE)")
  
  
  # Connect into one dataframe
  mean_ratios = cbind(conc, conc_sd, conc.indoor, conc_sd.indoor, conc.outdoor, conc_sd.outdoor,
                      bin0, bin0_sd, bin0.indoor, bin0_sd.indoor, bin0.outdoor, bin0_sd.outdoor,
                      neph_bin0, neph_bin0_sd, neph_bin0.indoor, neph_bin0_sd.indoor, neph_bin0.outdoor, neph_bin0_sd.outdoor, 
                      pm1, pm1_sd, pm1.indoor, pm1_sd.indoor, pm1.outdoor, pm1_sd.outdoor,
                      pm25, pm25_sd, pm25.indoor, pm25_sd.indoor, pm25.outdoor, pm25_sd.outdoor,
                      pm10, pm10_sd, pm10.indoor, pm10_sd.indoor, pm10.outdoor, pm10_sd.outdoor)
  return(mean_ratios)
}

LF_mean_ratios <- lapply(LF_ratio_list, function(x) calculate_mean_ratio(x)) %>%
  bind_rows() 

# Add labels to dataframe
LF_mean_ratios <- cbind(name = names, LF_mean_ratios)
LF_mean_ratios <- cbind(LF_mean_ratios, is_HEPA)

# Pivot wider for easier readability upon export
LF_mean_ratios <- LF_mean_ratios %>%
  pivot_wider(names_from = is_HEPA, names_sep = '.', values_from = -name) %>%
  mutate(conc_reduction = (conc.pre - conc.post)/conc.pre,
         bin0_reduction = (bin0.pre - bin0.post)/bin0.pre,
         neph_bin0_reduction = (neph_bin0.pre - neph_bin0.post)/neph_bin0.pre,
         pm1_reduction = (pm1.pre - pm1.post)/pm1.pre,
         pm25_reduction = (pm25.pre - pm25.post)/pm25.pre,
         pm10_reduction = (pm10.pre - pm10.post)/pm10.pre)

LF_mean_ratios

```

```{r}
calculate_pm_mean_ratio <- function(room) {
  bin0 <- room %>%
    filter(source=="bin0_ratio") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(bin0 = "mean(ratio, na.rm = TRUE)")
  bin0_sd <- room %>%
    filter(source=="bin0_ratio") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(bin0_sd = "sd(ratio, na.rm = TRUE)")
  bin0.indoor <- room %>%
    filter(source=="bin0.indoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(bin0.indoor = "mean(ratio, na.rm = TRUE)")
  bin0_sd.indoor <- room %>%
    filter(source=="bin0.indoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(bin0_sd.indoor = "sd(ratio, na.rm = TRUE)")
    bin0.outdoor <- room %>%
    filter(source=="bin0.outdoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(bin0.outdoor = "mean(ratio, na.rm = TRUE)")
  bin0_sd.outdoor <- room %>%
    filter(source=="bin0.outdoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(bin0_sd.outdoor = "sd(ratio, na.rm = TRUE)")
  
  neph_bin0 <- room %>%
    filter(source=="neph_bin0_ratio") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(neph_bin0 = "mean(ratio, na.rm = TRUE)")
  neph_bin0_sd <- room %>%
    filter(source=="neph_bin0_ratio") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(neph_bin0_sd = "sd(ratio, na.rm = TRUE)")
  neph_bin0.indoor <- room %>%
    filter(source=="neph_bin0.indoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(neph_bin0.indoor = "mean(ratio, na.rm = TRUE)")
  neph_bin0_sd.indoor <- room %>%
    filter(source=="neph_bin0.indoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(neph_bin0_sd.indoor = "sd(ratio, na.rm = TRUE)")
  neph_bin0.outdoor <- room %>%
    filter(source=="neph_bin0.outdoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(neph_bin0.outdoor = "mean(ratio, na.rm = TRUE)")
  neph_bin0_sd.outdoor <- room %>%
    filter(source=="neph_bin0.outdoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(neph_bin0_sd.outdoor = "sd(ratio, na.rm = TRUE)")
  
  
  pm1 <- room %>%
    filter(source=="pm1_ratio") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(pm1 = "mean(ratio, na.rm = TRUE)")
  pm1_sd <- room %>%
    filter(source=="pm1_ratio") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(pm1_sd = "sd(ratio, na.rm = TRUE)")
  pm1.indoor <- room %>%
    filter(source=="pm1.indoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(pm1.indoor = "mean(ratio, na.rm = TRUE)")
  pm1_sd.indoor <- room %>%
    filter(source=="pm1.indoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(pm1_sd.indoor = "sd(ratio, na.rm = TRUE)")
  pm1.outdoor <- room %>%
    filter(source=="pm1.outdoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(pm1.outdoor = "mean(ratio, na.rm = TRUE)")
  pm1_sd.outdoor <- room %>%
    filter(source=="pm1.outdoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(pm1_sd.outdoor = "sd(ratio, na.rm = TRUE)")
  
  
  pm25 <- room %>%
    filter(source=="pm25_ratio") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(pm25 = "mean(ratio, na.rm = TRUE)")
  pm25_sd <- room %>%
    filter(source=="pm25_ratio") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(pm25_sd = "sd(ratio, na.rm = TRUE)")
  pm25.indoor <- room %>%
    filter(source=="pm25.indoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(pm25.indoor = "mean(ratio, na.rm = TRUE)")
  pm25_sd.indoor <- room %>%
    filter(source=="pm25.indoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(pm25_sd.indoor = "sd(ratio, na.rm = TRUE)")
  pm25.outdoor <- room %>%
    filter(source=="pm25.outdoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(pm25.outdoor = "mean(ratio, na.rm = TRUE)")
  pm25_sd.outdoor <- room %>%
    filter(source=="pm25.outdoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(pm25_sd.outdoor = "sd(ratio, na.rm = TRUE)")
  

  pm10 <- room %>%
    filter(source=="pm10_ratio") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(pm10 = "mean(ratio, na.rm = TRUE)")
  pm10_sd <- room %>%
    filter(source=="pm10_ratio") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(pm10_sd = "sd(ratio, na.rm = TRUE)")
  pm10.indoor <- room %>%
    filter(source=="pm10.indoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(pm10.indoor = "mean(ratio, na.rm = TRUE)")
  pm10_sd.indoor <- room %>%
    filter(source=="pm10.indoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(pm10_sd.indoor = "sd(ratio, na.rm = TRUE)")
  pm10.outdoor <- room %>%
    filter(source=="pm10.outdoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(pm10.outdoor = "mean(ratio, na.rm = TRUE)")
  pm10_sd.outdoor <- room %>%
    filter(source=="pm10.outdoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(pm10_sd.outdoor = "sd(ratio, na.rm = TRUE)")

  
    mean_ratios = cbind(bin0, bin0_sd, bin0.indoor, bin0_sd.indoor, bin0.outdoor, bin0_sd.outdoor,
                      neph_bin0, neph_bin0_sd, neph_bin0.indoor, neph_bin0_sd.indoor, neph_bin0.outdoor, neph_bin0_sd.outdoor, 
                      pm1, pm1_sd, pm1.indoor, pm1_sd.indoor, pm1.outdoor, pm1_sd.outdoor,
                      pm25, pm25_sd, pm25.indoor, pm25_sd.indoor, pm25.outdoor, pm25_sd.outdoor,
                      pm10, pm10_sd, pm10.indoor, pm10_sd.indoor, pm10.outdoor, pm10_sd.outdoor)
  return(mean_ratios)
}

LF_pm_mean_ratios <- lapply(LF_pm_ratio_list, function(x) calculate_pm_mean_ratio(x)) %>%
  bind_rows() 

pm_names = c("admin", "class1", "class3")
pm_is_HEPA = c("pre", "pre", "pre", "post", "post", "post")

LF_pm_mean_ratios <- cbind(name = pm_names, LF_pm_mean_ratios)
LF_pm_mean_ratios <- cbind(LF_pm_mean_ratios, pm_is_HEPA)

LF_pm_mean_ratios <- LF_pm_mean_ratios %>%
  pivot_wider(names_from = pm_is_HEPA, names_sep = '.', values_from = -name) %>%
  mutate(bin0_reduction = (bin0.pre - bin0.post)/bin0.pre,
         neph_bin0_reduction = (neph_bin0.pre - neph_bin0.post)/neph_bin0.pre,
         pm1_reduction = (pm1.pre - pm1.post)/pm1.pre,
         pm25_reduction = (pm25.pre - pm25.post)/pm25.pre,
         pm10_reduction = (pm10.pre - pm10.post)/pm10.pre)

LF_pm_mean_ratios
```
Here, we'll export the data to a .csv file for further data analysis.

```{r}
write.table(LF_mean_ratios, "LF_mean_ratios.csv", append = FALSE, sep = ",", dec = ".",
            row.names = FALSE, col.names = TRUE)
write.table(LF_pm_mean_ratios, "LF_pm_mean_ratios.csv", append = FALSE, sep = ",", dec = ".",
            row.names = FALSE, col.names = TRUE)
```


## Plot Concentration Changes

Let's investigate the data by using boxplots. Before we do that, though, we 
must distinguish which data is before and after the purifier installation.

```{r}
# Combine Class 2 data
LF_ratio_list$class2 <- LF_ratio_list$class2 %>%
  mutate(is_HEPA = "no")

LF_ratio_list$class2_HEPA <- LF_ratio_list$class2_HEPA %>%
  mutate(is_HEPA = "yes")

class2_combined <- rbind(LF_ratio_list$class2, LF_ratio_list$class2_HEPA)


# Prep for boxplot
class2_boxplot_ratios <- class2_combined %>%
  filter(source == "concent_ratio" | source == "bin0_ratio"| source == "neph_bin0_ratio" | source == "pm1_ratio" | source == "pm25_ratio" | source ==  "pm10_ratio")

class2_boxplot_ratios$source <- factor(class2_boxplot_ratios$source , levels=c("concent_ratio", "bin0_ratio", "neph_bin0_ratio", 
                        "pm1_ratio", "pm25_ratio", "pm10_ratio"))

# Combine Class 4 data
LF_ratio_list$class4 <- LF_ratio_list$class4 %>%
  mutate(is_HEPA = "no")

LF_ratio_list$class4_HEPA <- LF_ratio_list$class4_HEPA %>%
  mutate(is_HEPA = "yes")

class4_combined <- rbind(LF_ratio_list$class4, LF_ratio_list$class4_HEPA)


# Prep for boxplot
class4_boxplot_ratios <- class4_combined %>%
  filter(source == "concent_ratio" | source == "bin0_ratio"| source == "neph_bin0_ratio" | source == "pm1_ratio" | source == "pm25_ratio" | source ==  "pm10_ratio")

class4_boxplot_ratios$source <- factor(class4_boxplot_ratios$source , levels=c("concent_ratio", "bin0_ratio", "neph_bin0_ratio", 
                        "pm1_ratio", "pm25_ratio", "pm10_ratio"))


```

We will use the built-in ggplot2 boxplot and adjust the visuals to our needs.

### Class 2

```{r}

# Nice labels for facet_grid
source.labs <- c("CPC Conc.", "Bin 0", "Neph. Bin 0", "PM1", "PM2.5", "PM10")
names(source.labs) <- c("concent_ratio", "bin0_ratio", "neph_bin0_ratio", 
                        "pm1_ratio", "pm25_ratio", "pm10_ratio")

class2_boxplot <- ggplot(data=class2_boxplot_ratios, aes(x=source, y=ratio, fill=is_HEPA)) +
  geom_boxplot() +
  
  # separate visually by measurement and move labels to bottom of boxplot
  facet_grid(. ~ source, scales='free_x',
             labeller = labeller(source = source.labs),
             switch = "x") +
  
  # label graph
  labs(title="Effect of HEPA Purifiers on Particle Ratios",
       subtitle= "Little Folks: Class 2",
       x="Particle Ratio Type",
       y="Indoor/Outdoor Ratio") +

  # Change legend and use blue theme
  scale_fill_brewer(name = "Sensor Measurements",
                    labels = c("Initial Recording", 
                                 "After HEPA Installation"),
                    palette="Blues") +
  

  # Clean up axes
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()) +

  # Set limits  
  ylim(0,3)
class2_boxplot

# Save image
ggsave("LF_class2_box.png")
```
### Class 4

```{r}
class4_boxplot <- ggplot(data=class4_boxplot_ratios, aes(x=source, y=ratio, fill=is_HEPA)) +
  geom_boxplot() +
  
  # separate visually by measurement and move labels to bottom of boxplot
  facet_grid(. ~ source, scales='free_x',
             labeller = labeller(source = source.labs),
             switch = "x") +
  
  # label graph
  labs(title="Effect of HEPA Purifiers on Particle Ratios",
       subtitle= "Little Folks: Class 4",
       x="Particle Ratio Type",
       y="Indoor/Outdoor Ratio") +

  # Change legend and use blue theme
  scale_fill_brewer(name = "Sensor Measurements",
                    labels = c("Initial Recording", 
                                 "After HEPA Installation"),
                    palette="Blues") +
  

  # Clean up axes
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()) +

  # Set limits  
  ylim(0,1)

class4_boxplot

# Save image
ggsave("LF_class4_box.png")
```

Let's do the same for the data that was only Modulair-PM-sourced.

```{r}
# Combine Admin data
LF_pm_ratio_list$admin <- LF_pm_ratio_list$admin %>%
  mutate(is_HEPA = "no")

LF_pm_ratio_list$admin_HEPA <- LF_pm_ratio_list$admin_HEPA %>%
  mutate(is_HEPA = "yes")

admin_combined <- rbind(LF_pm_ratio_list$admin, LF_pm_ratio_list$admin_HEPA)

admin_boxplot_ratios <- admin_combined %>%
  filter(source == "bin0_ratio"| source == "neph_bin0_ratio" | source == "pm1_ratio" | source == "pm25_ratio" | source ==  "pm10_ratio")

admin_boxplot_ratios$source <- factor(admin_boxplot_ratios$source , levels=c("bin0_ratio", "neph_bin0_ratio", 
                        "pm1_ratio", "pm25_ratio", "pm10_ratio"))

# Combine Class 1 data
LF_pm_ratio_list$class1 <- LF_pm_ratio_list$class1 %>%
  mutate(is_HEPA = "no")

LF_pm_ratio_list$class1_HEPA <- LF_pm_ratio_list$class1_HEPA %>%
  mutate(is_HEPA = "yes")

class1_combined <- rbind(LF_pm_ratio_list$class1, LF_pm_ratio_list$class1_HEPA)

class1_boxplot_ratios <- class1_combined %>%
  filter(source == "bin0_ratio"| source == "neph_bin0_ratio" | source == "pm1_ratio" | source == "pm25_ratio" | source ==  "pm10_ratio")

class1_boxplot_ratios$source <- factor(class1_boxplot_ratios$source , levels=c("bin0_ratio", "neph_bin0_ratio", 
                        "pm1_ratio", "pm25_ratio", "pm10_ratio"))


# Combine Class 3 data
LF_pm_ratio_list$class3 <- LF_pm_ratio_list$class3 %>%
  mutate(is_HEPA = "no")

LF_pm_ratio_list$class3_HEPA <- LF_pm_ratio_list$class3_HEPA %>%
  mutate(is_HEPA = "yes")

class3_combined <- rbind(LF_pm_ratio_list$class3, LF_pm_ratio_list$class3_HEPA)

class3_boxplot_ratios <- class3_combined %>%
  filter(source == "bin0_ratio"| source == "neph_bin0_ratio" | source == "pm1_ratio" | source == "pm25_ratio" | source ==  "pm10_ratio")

class3_boxplot_ratios$source <- factor(class3_boxplot_ratios$source , levels=c("bin0_ratio", "neph_bin0_ratio", 
                        "pm1_ratio", "pm25_ratio", "pm10_ratio"))


```

```{r}
source.labs <- c("Bin 0", "Neph. Bin 0", "PM1", "PM2.5", "PM10")
names(source.labs) <- c("bin0_ratio", "neph_bin0_ratio", 
                        "pm1_ratio", "pm25_ratio", "pm10_ratio")

admin_boxplot <- ggplot(data=admin_boxplot_ratios, aes(x=source, y=ratio, fill=is_HEPA)) +
  geom_boxplot() +
  
  facet_grid(. ~ source, scales='free_x',
             labeller = labeller(source = source.labs),
             switch = "x") +
  
  
  labs(title="Effect of HEPA Purifiers on Particle Ratios",
       subtitle= "Little Folks: Admin Room",
       x="Particle Ratio Type",
       y="Indoor/Outdoor Ratio") +

  
  scale_fill_brewer(name = "Sensor Measurements",
                    labels = c("Initial Recording", 
                                 "After HEPA Installation"),
                    palette="Blues") +
  

  
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()) +

  ylim(0,1)

admin_boxplot
ggsave("LF_admin_box.png")
```

```{r}
class1_boxplot <- ggplot(data=class1_boxplot_ratios, aes(x=source, y=ratio, fill=is_HEPA)) +
  geom_boxplot() +
  
  facet_grid(. ~ source, scales='free_x',
             labeller = labeller(source = source.labs),
             switch = "x") +
  
  
  labs(title="Effect of HEPA Purifiers on Particle Ratios",
       subtitle= "Little Folks: Class 1",
       x="Particle Ratio Type",
       y="Indoor/Outdoor Ratio") +

  
  scale_fill_brewer(name = "Sensor Measurements",
                    labels = c("Initial Recording", 
                                 "After HEPA Installation"),
                    palette="Blues") +
  

  
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()) +

  ylim(0,1)
class1_boxplot
ggsave("LF_class1_box.png")
```


```{r}
class3_boxplot <- ggplot(data=class3_boxplot_ratios, aes(x=source, y=ratio, fill=is_HEPA)) +
  geom_boxplot() +
  
  facet_grid(. ~ source, scales='free_x',
             labeller = labeller(source = source.labs),
             switch = "x") +
  
  
  labs(title="Effect of HEPA Purifiers on Particle Ratios",
       subtitle= "Little Folks: Class 3",
       x="Particle Ratio Type",
       y="Indoor/Outdoor Ratio") +

  
  scale_fill_brewer(name = "Sensor Measurements",
                    labels = c("Initial Recording", 
                                 "After HEPA Installation"),
                    palette="Blues") +
  

  
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()) +

  ylim(0,1)

class3_boxplot
ggsave("LF_class3_box.png")
```
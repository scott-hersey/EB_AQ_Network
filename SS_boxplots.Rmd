---
title: "hepa_impact"
author: "Megan Ku"
date: "3/4/2021"
output: html_document
---

```{r setup, warning= FALSE, error = FALSE}
library(lubridate) #date and time functions 
library(data.table) #to use the data.table variable type
library(dplyr) #this library allows you to use the %>% operator
library(tidyr) #this library lets you use the complete function to account for time syncing
library(openair) #for plotting and analysis
library(stringr)
library(readr) #read .csv files
library(ggplot2) #plotting
source("filter_data.R")
source("make_boxplots.R")
```

# HEPA Impact Plots for Shining Star

This notebook focuses on creating visuals to highlight the impact of HEPA
purifiers on particle concentration in classrooms.

## Setup

## Import Data

The variables of interest to us are the following:

- concent_ratio: indoor/outdoor concentration ratio for CPC data as calculated 
in hepa_main.Rmd
- concent_1.indoor/.outdoor: used to calculate concent_ratio
- bin0: smallest particle size from Mod-PM
- neph_bin0: used to calculate pm1, pm2.5, and pm10 (nephlometer)
- pm1, pm2.5, pm10: regulated particle sizes from EPA
- HEPA_on: purifier active state

We can ignore parsing failures for columns we won't be utilizing. We'll combine 
the imported data frames into one list.

```{r}
kitchen_ratio <- import_ratio_data('./data/SS_kitchen_filt.csv')
front_ratio <- import_ratio_data('./data/SS_front_filt.csv')
preschool_ratio <- import_ratio_data('./data/SS_preschool_filt.csv', TRUE)
toddler_ratio <- import_ratio_data('./data/SS_toddler_filt.csv')
infant_ratio <- import_ratio_data('./data/SS_infant_filt.csv', TRUE)
```

Looking at hepa_main.Rmd, it seems that it's more useful to keep all structures
as a list. That way, if we need to apply the same function to each data frame, 
we can do so with a function.

```{r}
CPC_ratio_list <- list(
  "preschool" = preschool_ratio,
  "infant" = infant_ratio
  )

# PM-only data
PM_ratio_list <- list(
  "kitchen" = kitchen_ratio,
  "front" = front_ratio,
  "toddler" = toddler_ratio
)
```

To make the data frame more manageable, we'll only select specific columns. We 
will also calculate indoor/outdoor ratios for all particle sizes.


```{r}
CPC_focus_list <- lapply(CPC_ratio_list,  simplify_ratio_data, is_CPC=TRUE)
PM_focus_list <- lapply(PM_ratio_list,  simplify_ratio_data) 
```

## Pre-Processing

### Tidy dataset


It is good practice that a dataset be *tidy*. We will make this data tidier by
transposing the columns.

```{r}
CPC_focus_tidy <- lapply(CPC_focus_list,  function(x) tidy_data(x))
PM_focus_tidy <- lapply(PM_focus_list, function(x) tidy_data(x))
```

### Identify pre/post HEPA purifiers

Let's filter the data for the times before and after the HEPA purifiers were
installed.

```{r}
CPC_tidy_split <- vector(mode = "list", length = 1)
PM_tidy_split <- vector(mode = "list", length = 1)

# Preschool
CPC_tidy_split$preschool.post <- CPC_focus_tidy$preschool %>%
`filter`(HEPA_on == 1)

CPC_tidy_split$preschool.pre <- CPC_focus_tidy$preschool %>%
  filter(HEPA_on == 0)

# Infant
CPC_tidy_split$infant.post <- CPC_focus_tidy$infant %>%
  filter(HEPA_on == 1)

CPC_tidy_split$infant.pre <- CPC_focus_tidy$infant %>%
  filter(HEPA_on == 0)

# kitchen
PM_tidy_split$kitchen.post <- PM_focus_tidy$kitchen %>%
  filter(HEPA_on == 1)

PM_tidy_split$kitchen.pre <- PM_focus_tidy$kitchen %>%
  filter(HEPA_on == 0)

# Front
PM_tidy_split$front.post <- PM_focus_tidy$front %>%
  filter(HEPA_on == 1)

PM_tidy_split$front.pre <- PM_focus_tidy$front %>%
  filter(HEPA_on == 0)

# Toddler
PM_tidy_split$toddler.post <- PM_focus_tidy$toddler %>%
  filter(HEPA_on == 1)

PM_tidy_split$toddler.pre <- PM_focus_tidy$toddler %>%
  filter(HEPA_on == 0)

# Remove placeholders
CPC_tidy_split <- CPC_tidy_split[lengths(CPC_tidy_split) != 0]
PM_tidy_split <- PM_tidy_split[lengths(PM_tidy_split) != 0]
```

Let's calculate the mean concentration ratios before and after the HEPA 
installation, as well as the standard deviations. We'll store this in another 
dataset, which we will also tidy up.

```{r}
names = c("preschool", "infant", "preschool", "infant")

is_HEPA = c("pre", "pre", "post", "post")

CPC_mean_ratios <- lapply(CPC_tidy_split, calculate_mean_ratio, TRUE) %>%
  bind_rows()

# Add labels to dataframe
CPC_mean_ratios <- cbind(name = names, CPC_mean_ratios)
CPC_mean_ratios <- cbind(CPC_mean_ratios, is_HEPA)

# Pivot wider for easier readability upon export
CPC_mean_ratios <- CPC_mean_ratios %>%
  pivot_wider(names_from = is_HEPA, names_sep = '.', values_from = -name) %>%
  mutate(conc_reduction = (conc.pre - conc.post)/conc.pre,
         bin0_reduction = (bin0.pre - bin0.post)/bin0.pre,
         neph_bin0_reduction = (neph_bin0.pre - neph_bin0.post)/neph_bin0.pre,
         pm1_reduction = (pm1.pre - pm1.post)/pm1.pre,
         pm25_reduction = (pm25.pre - pm25.post)/pm25.pre,
         pm10_reduction = (pm10.pre - pm10.post)/pm10.pre)

CPC_mean_ratios
```

```{r}
PM_mean_ratios <- lapply(PM_tidy_split, calculate_mean_ratio) %>%
  bind_rows()

names = c("kitchen", "front", "toddler")
is_HEPA = c("pre", "pre", "pre", "post", "post", "post")

PM_mean_ratios <- cbind(name = names, PM_mean_ratios)
PM_mean_ratios <- cbind(PM_mean_ratios, is_HEPA)

PM_mean_ratios <- PM_mean_ratios %>%
  pivot_wider(names_from = is_HEPA, names_sep = '.', values_from = -name) %>%
  mutate(bin0_reduction = (bin0.pre - bin0.post)/bin0.pre,
         neph_bin0_reduction = (neph_bin0.pre - neph_bin0.post)/neph_bin0.pre,
         pm1_reduction = (pm1.pre - pm1.post)/pm1.pre,
         pm25_reduction = (pm25.pre - pm25.post)/pm25.pre,
         pm10_reduction = (pm10.pre - pm10.post)/pm10.pre)

PM_mean_ratios
```
Here, we'll export the data to a .csv file for further data analysis.

```{r}
write.table(CPC_mean_ratios, "SS_mean_ratios.csv", append = FALSE, sep = ",", dec = ".",
            row.names = FALSE, col.names = TRUE)
write.table(PM_mean_ratios, "SS_pm_mean_ratios.csv", append = FALSE, sep = ",", dec = ".",
            row.names = FALSE, col.names = TRUE)
```


## Plot Concentration Changes

Let's investigate the data by using boxplots. Before we do that, though, we 
must distinguish which data is before and after the purifier installation.

```{r}
# Prep for boxplot
preschool_boxplot_ratios <- CPC_focus_tidy$preschool %>%
  mutate(HEPA_on = as.character(HEPA_on)) %>%
  filter(source == "concent_ratio" | source == "bin0_ratio"| 
           source == "neph_bin0_ratio" | source == "pm1_ratio" | 
           source == "pm25_ratio" | source ==  "pm10_ratio")

preschool_boxplot_ratios$source <- factor(
  preschool_boxplot_ratios$source, 
  levels=c("concent_ratio", "bin0_ratio", "neph_bin0_ratio", 
                        "pm1_ratio", "pm25_ratio", "pm10_ratio"))


infant_boxplot_ratios <- CPC_focus_tidy$infant %>%
  mutate(HEPA_on = as.character(HEPA_on)) %>%
  filter(source == "concent_ratio" | source == "bin0_ratio"| 
           source == "neph_bin0_ratio" | source == "pm1_ratio" | 
           source == "pm25_ratio" | source ==  "pm10_ratio")

infant_boxplot_ratios$source <- factor(
  infant_boxplot_ratios$source , 
  levels=c("concent_ratio", "bin0_ratio", "neph_bin0_ratio", 
                        "pm1_ratio", "pm25_ratio", "pm10_ratio"))
```

We will use the built-in ggplot2 boxplot and adjust the visuals to our needs.

### Preschool

```{r, fig.height=5}
# Nice labels for facet_grid
source.labs <- c("CPC Conc.", "Bin 0", "Neph. Bin 0", "PM1", "PM2.5", "PM10")
names(source.labs) <- c("concent_ratio", "bin0_ratio", "neph_bin0_ratio", 
                        "pm1_ratio", "pm25_ratio", "pm10_ratio")

preschool_boxplot <- ggplot(data=preschool_boxplot_ratios, aes(x=source, y=ratio, fill=HEPA_on)) +
  geom_boxplot() +
  
  # separate visually by measurement and move labels to bottom of boxplot
  facet_grid(. ~ source, scales='free_x',
             labeller = labeller(source = source.labs),
             switch = "x") +
  
  # label graph
  labs(title="Effect of HEPA Purifiers on Particle Ratios",
       subtitle= "Shining Star: Preschool",
       x="Particle Ratio Type",
       y="Indoor/Outdoor Ratio") +

  # Change legend and use blue theme
  scale_fill_brewer(name = "Sensor Measurements",
                    labels = c("Initial Recording", 
                                 "After HEPA Installation"),
                    palette="Blues") +
  

  # Clean up axes
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()) +

  # Set limits  
  ylim(0,1)
preschool_boxplot

# Save image
ggsave("SS_preschool_box.png")
```
### Infant

```{r, fig.height=5}
infant_boxplot <- ggplot(data=infant_boxplot_ratios, aes(x=source, y=ratio, fill=HEPA_on)) +
  geom_boxplot() +
  
  # separate visually by measurement and move labels to bottom of boxplot
  facet_grid(. ~ source, scales='free_x',
             labeller = labeller(source = source.labs),
             switch = "x") +
  
  # label graph
  labs(title="Effect of HEPA Purifiers on Particle Ratios",
       subtitle= "Shining Star: Infant",
       x="Particle Ratio Type",
       y="Indoor/Outdoor Ratio") +

  # Change legend and use blue theme
  scale_fill_brewer(name = "Sensor Measurements",
                    labels = c("Initial Recording", 
                                 "After HEPA Installation"),
                    palette="Blues") +
  

  # Clean up axes
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()) +

  # Set limits  
  ylim(0,1)

infant_boxplot

# Save image
ggsave("SS_infant_box.png")
```


Let's do the same for the data that was only Modulair-PM-sourced.

```{r, fig.height=5}
# Combine kitchen data
kitchen_boxplot_ratios <- PM_focus_tidy$kitchen %>%
  mutate(HEPA_on = as.character(HEPA_on)) %>%
  filter(source == "bin0_ratio"| source == "neph_bin0_ratio" | source == "pm1_ratio" | source == "pm25_ratio" | source ==  "pm10_ratio")

kitchen_boxplot_ratios$source <- factor(kitchen_boxplot_ratios$source , levels=c("bin0_ratio", "neph_bin0_ratio", 
                        "pm1_ratio", "pm25_ratio", "pm10_ratio"))


front_boxplot_ratios <- PM_focus_tidy$front %>%
  mutate(HEPA_on = as.character(HEPA_on)) %>%
  filter(source == "bin0_ratio"| source == "neph_bin0_ratio" | source == "pm1_ratio" | source == "pm25_ratio" | source ==  "pm10_ratio")

front_boxplot_ratios$source <- factor(front_boxplot_ratios$source , levels=c("bin0_ratio", "neph_bin0_ratio", 
                        "pm1_ratio", "pm25_ratio", "pm10_ratio"))


toddler_boxplot_ratios <- PM_focus_tidy$toddler %>%
  mutate(HEPA_on = as.character(HEPA_on)) %>%
  filter(source == "bin0_ratio"| source == "neph_bin0_ratio" | 
           source == "pm1_ratio" | source == "pm25_ratio" | source ==  "pm10_ratio")

toddler_boxplot_ratios$source <- factor(
  toddler_boxplot_ratios$source , levels=c("bin0_ratio", "neph_bin0_ratio", 
                        "pm1_ratio", "pm25_ratio", "pm10_ratio"))
```

```{r, fig.height=5}
source.labs <- c("Bin 0", "Neph. Bin 0", "PM1", "PM2.5", "PM10")
names(source.labs) <- c("bin0_ratio", "neph_bin0_ratio", 
                        "pm1_ratio", "pm25_ratio", "pm10_ratio")

kitchen_boxplot <- ggplot(data=kitchen_boxplot_ratios, aes(x=source, y=ratio, fill=HEPA_on)) +
  geom_boxplot() +
  
  facet_grid(. ~ source, scales='free_x',
             labeller = labeller(source = source.labs),
             switch = "x") +
  
  
  labs(title="Effect of HEPA Purifiers on Particle Ratios",
       subtitle= "Shining Star: kitchen Room",
       x="Particle Ratio Type",
       y="Indoor/Outdoor Ratio") +

  
  scale_fill_brewer(name = "Sensor Measurements",
                    labels = c("Initial Recording", 
                                 "After HEPA Installation"),
                    palette="Blues") +
  

  
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()) +

  ylim(0,1)

kitchen_boxplot
ggsave("SS_kitchen_box.png")
```

```{r, fig.height=5}
front_boxplot <- ggplot(data=front_boxplot_ratios, aes(x=source, y=ratio, fill=HEPA_on)) +
  geom_boxplot() +
  
  facet_grid(. ~ source, scales='free_x',
             labeller = labeller(source = source.labs),
             switch = "x") +
  
  
  labs(title="Effect of HEPA Purifiers on Particle Ratios",
       subtitle= "Shining Star: Front Room",
       x="Particle Ratio Type",
       y="Indoor/Outdoor Ratio") +

  
  scale_fill_brewer(name = "Sensor Measurements",
                    labels = c("Initial Recording", 
                                 "After HEPA Installation"),
                    palette="Blues") +
  

  
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()) +

  ylim(0,1)
front_boxplot
ggsave("SS_front_box.png")
```


```{r, fig.height=5}
toddler_boxplot <- ggplot(data=toddler_boxplot_ratios, aes(x=source, y=ratio, fill=HEPA_on)) +
  geom_boxplot() +
  
  facet_grid(. ~ source, scales='free_x',
             labeller = labeller(source = source.labs),
             switch = "x") +
  
  
  labs(title="Effect of HEPA Purifiers on Particle Ratios",
       subtitle= "Shining Star: Toddler",
       x="Particle Ratio Type",
       y="Indoor/Outdoor Ratio") +

  
  scale_fill_brewer(name = "Sensor Measurements",
                    labels = c("Initial Recording", 
                                 "After HEPA Installation"),
                    palette="Blues") +
  

  
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()) +

  ylim(0,1)

toddler_boxplot
ggsave("SS_toddler_box.png")
```

```{r}
kitchen_quartile <- ggplot_build(kitchen_boxplot)$data[[1]] %>%
  select(-outliers)
front_quartile <- ggplot_build(front_boxplot)$data[[1]] %>%
  select(-outliers)
preschool_quartile <- ggplot_build(preschool_boxplot)$data[[1]] %>%
  select(-outliers)
toddler_quartile <- ggplot_build(toddler_boxplot)$data[[1]] %>%
  select(-outliers)
infant_quartile <- ggplot_build(infant_boxplot)$data[[1]] %>%
  select(-outliers)

SS_med <- list('SS_kitchen_quartile' = kitchen_quartile, 
               'SS_front_quartile'= front_quartile, 
               'SS_preschool_quartile'= preschool_quartile, 
               'SS_toddler_quartile'= toddler_quartile,
               'SS_infant_quartile'= infant_quartile)
```
```{r}
mapply(
  write.table, #apply function write table
  x=SS_med, file=paste("data", paste(names(SS_med), "csv", sep="."), sep="/"), #for each dataframe, use its name to make a csv of it
  MoreArgs=list(row.names=FALSE, sep=",")
)
```


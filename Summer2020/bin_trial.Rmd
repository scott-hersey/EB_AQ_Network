---
title: "Testing Bins"

---

# Overview 

In this notebook, I explore different ways of converting the 15 bin measurements to 6 bin measurements.

In the end, I use the fourth method, which I use to change the sensor data directly in this notebook. I also put this method in the functions folder as well.

# Importing data and packages 

```{r warning = FALSE, error = FALSE}
library(openair)
library(lubridate)
library(dplyr)
library(data.table)
```

```{r}
sn45 <- read.csv("data/sn45.csv", header= TRUE)
sn45$date <- as.POSIXct(sn45$date, format="%m/%d/%Y %H:%M",  tz = "America/New_York")
```


# Splitting Dataframe 

I split the dataframe based on whether or not the new sensors were used (15 bins vs 6)

```{r}
# Data that has six bins 
six_bin_data <- sn45[which( sn45$bin14 == 0 & 
  sn45$bin13 == 0 & 
            sn45$bin12 == 0 & 
             sn45$bin11 == 0 & 
             sn45$bin10 == 0 &
             sn45$bin9 == 0 & 
             sn45$bin8 == 0 & 
             sn45$bin7 == 0 &
             sn45$bin6 == 0 
           ),c("date", "bin0", "bin1", "bin2", "bin3", "bin4", "bin5", "bin6", "bin7", "bin8", "bin9", "bin10", "bin11", "bin12", "bin13", "bin14")]


six_bin_data_filter <- six_bin_data[!is.na(six_bin_data$bin0) & !is.na(six_bin_data$bin1) & !is.na(six_bin_data$bin2) & 
                                      !is.na(six_bin_data$bin3) & !is.na(six_bin_data$bin4) & !is.na(six_bin_data$bin5), ]
six_bin_data_filter <- six_bin_data_filter[which(rowSums(six_bin_data_filter[, 2:16]) > 0.005),] 

fifteen_bin_data <- sn45[!(sn45$date %in% six_bin_data$date), 
                         c("date", "bin0", "bin1", "bin2", "bin3", "bin4", "bin5", "bin6", "bin7", "bin8", "bin9", "bin10", "bin11", "bin12", "bin13", "bin14")]

fifteen_bin_data_filter <- fifteen_bin_data[ !is.na(fifteen_bin_data$bin0) & !is.na(fifteen_bin_data$bin1) & 
                                                                 !is.na(fifteen_bin_data$bin2) & !is.na(fifteen_bin_data$bin3) & 
                                                                   !is.na(fifteen_bin_data$bin4) & !is.na(fifteen_bin_data$bin5) , ]
```



# First Method

For the first method, I tried this workflow:

Divide original bin values by original bin width -> add bins together

```{r}

first_method <- fifteen_bin_data #creating new dataframe in order to be able to manipulate


# Creating some before plots 


  timePlot(first_method, pollutant=c("bin0","bin1", "bin2", "bin3", "bin4", "bin5", "bin6", "bin7", "bin8", "bin9", "bin10", "bin11", "bin12", "bin13", "bin14"), group=TRUE) #plot what it looks like before
  
  barplot(unlist(first_method[100, c("bin0","bin1", "bin2", "bin3", "bin4", "bin5", "bin6", "bin7", "bin8", "bin9", "bin10", "bin11", "bin12", "bin13", "bin14")]),
          main = "Particle Number vs Particle Size - Ex 1 Before",
          names.arg = c("bin0","bin1", "bin2", "bin3", "bin4", "bin5", "bin6", "bin7", "bin8", "bin9", "bin10", "bin11", "bin12", "bin13", "bin14"),
  ) # an example of what the bins look like in one instant in time 
  
  
  barplot(unlist(first_method[25, c("bin0","bin1", "bin2", "bin3", "bin4", "bin5", "bin6", "bin7", "bin8", "bin9", "bin10", "bin11", "bin12", "bin13", "bin14")]),
          main = "Particle Number vs Particle Size - Ex 2 Before",
          names.arg = c("bin0","bin1", "bin2", "bin3", "bin4", "bin5", "bin6", "bin7", "bin8", "bin9", "bin10", "bin11", "bin12", "bin13", "bin14"),
  ) #how the bins look like in another instant in time 

  
  
  first_method$bin0 <- first_method$bin0 / 0.05 # dividing by bin width
  first_method$bin1 <- first_method$bin1 / 0.05 
  first_method$bin2 <- first_method$bin2 / 0.05
  first_method$bin3 <- first_method$bin3 / 0.05
  first_method$bin4 <- first_method$bin4 / 0.1
  first_method$bin5 <- first_method$bin5 / 0.1
  first_method$bin6 <- first_method$bin6 / 0.1
  first_method$bin7 <- first_method$bin7 / 0.1
  first_method$bin8 <- first_method$bin8 / 0.1
  first_method$bin9 <- first_method$bin9 / 0.5
  first_method$bin10 <- first_method$bin10 / 0.5
  first_method$bin11 <- first_method$bin11 / 0.5 
  first_method$bin12 <- first_method$bin12 / 2.5
  first_method$bin13 <- first_method$bin13 / 2.5
  first_method$bin14 <- first_method$bin14 / 2.5
  
  #next we add the bins together
  first_method$bin0 <- first_method$bin0  + 
    first_method$bin1 + first_method$bin2
  
  first_method$bin1 <- first_method$bin3 + first_method$bin4
  
  first_method$bin2 <- first_method$bin5  + first_method$bin6
  
  first_method$bin3 <- first_method$bin7 + first_method$bin8
  first_method$bin4 <- first_method$bin9  + 
    first_method$bin10 + first_method$bin11
  
  first_method$bin5 <- first_method$bin12  + 
    first_method$bin13 + first_method$bin14
  
  #getting rid of unused variables
  first_method$bin6 <- NULL
  first_method$bin7 <- NULL
  first_method$bin8 <- NULL
  first_method$bin9 <- NULL
  first_method$bin10 <- NULL
  first_method$bin11 <- NULL
  first_method$bin12 <- NULL
  first_method$bin13 <- NULL
  first_method$bin14 <- NULL
  
  # plots to show what the effect of method 1
  timePlot(first_method, pollutant=c("bin0","bin1", "bin2", "bin3", "bin4", "bin5"), group=TRUE) #plot what it looks like now
  
  barplot(unlist(first_method[100, c("bin0","bin1", "bin2", "bin3", "bin4", "bin5")]),
          main = "Particle Number vs Particle Size - Ex 1 Afterwards",
          names.arg = c("bin0","bin1", "bin2", "bin3", "bin4", "bin5"),
  )
  
  barplot(unlist(first_method[25, c("bin0","bin1", "bin2", "bin3", "bin4", "bin5")]),
          main = "Particle Number vs Particle Size - Ex 2 Afterwards ",
          names.arg = c("bin0","bin1", "bin2", "bin3", "bin4", "bin5"),
  )

```

```{r}
mean(dates_to_keep$bin0, na.rm = TRUE)
mean(first_method$bin0, na.rm = TRUE)
```

# Second Method 

The workflow for this method was : 

add bins together -> divide by new bin length

```{r}

second_method <- fifteen_bin_data


  timePlot(second_method, pollutant=c("bin0","bin1", "bin2", "bin3", "bin4", "bin5", "bin6", "bin7", "bin8", "bin9", "bin10", "bin11", "bin12", "bin13", "bin14"), group=TRUE) #plot what it looks like before
  barplot(unlist(second_method[100, c("bin0","bin1", "bin2", "bin3", "bin4", "bin5", "bin6", "bin7", "bin8", "bin9", "bin10", "bin11", "bin12", "bin13", "bin14")]),
          main = "Particle Number vs Particle Size - Ex 1 Before",
          names.arg = c("bin0","bin1", "bin2", "bin3", "bin4", "bin5", "bin6", "bin7", "bin8", "bin9", "bin10", "bin11", "bin12", "bin13", "bin14"),
  )
  barplot(unlist(second_method[25, c("bin0","bin1", "bin2", "bin3", "bin4", "bin5", "bin6", "bin7", "bin8", "bin9", "bin10", "bin11", "bin12", "bin13", "bin14")]),
          main = "Particle Number vs Particle Size - Ex 2 Before",
          names.arg = c("bin0","bin1", "bin2", "bin3", "bin4", "bin5", "bin6", "bin7", "bin8", "bin9", "bin10", "bin11", "bin12", "bin13", "bin14"),
  )


  
#next we add the bins together
second_method$bin0 <- second_method$bin0  + 
second_method$bin1 + second_method$bin2

second_method$bin1 <- second_method$bin3 + second_method$bin4

second_method$bin2 <- second_method$bin5  + second_method$bin6

second_method$bin3 <- second_method$bin7 + second_method$bin8
second_method$bin4 <- second_method$bin9  + 
second_method$bin10 + second_method$bin11

second_method$bin5 <- second_method$bin12  + 
second_method$bin13 + second_method$bin14

second_method$bin0 <- second_method$bin0 / 0.15 
second_method$bin1 <- second_method$bin1 / 0.15 # dividing by bin width
second_method$bin2 <- second_method$bin2 / 0.15
second_method$bin3 <- second_method$bin3 / 0.25
second_method$bin4 <- second_method$bin4 / 1.5
second_method$bin5 <- second_method$bin5 / 7.5

  
#getting rid of unused variables
second_method$bin6 <- NULL
second_method$bin7 <- NULL
second_method$bin8 <- NULL
second_method$bin9 <- NULL
second_method$bin10 <- NULL
second_method$bin11 <- NULL
second_method$bin12 <- NULL
second_method$bin13 <- NULL
second_method$bin14 <- NULL
second_method$X.1 <- NULL
second_method$X <- NULL


#plots for method 2's effect

timePlot(second_method, pollutant=c("bin0","bin1", "bin2", "bin3", "bin4", "bin5"), group=TRUE) #plot what it looks like now
barplot(unlist(first_method[100, c("bin0","bin1", "bin2", "bin3", "bin4", "bin5")]),
        main = "Particle Number vs Particle Size - Ex 1 Afterwards",
        names.arg = c("bin0","bin1", "bin2", "bin3", "bin4", "bin5"),
)
barplot(unlist(second_method[25, c("bin0","bin1", "bin2", "bin3", "bin4", "bin5")]),
        main = "Particle Number vs Particle Size - Ex 2 Afterwards ",
        names.arg = c("bin0","bin1", "bin2", "bin3", "bin4", "bin5"),
)
```

```{r}
mean(dates_to_keep$bin0, na.rm = TRUE)
mean(second_method$bin0, na.rm = TRUE)
mean(first_method$bin0, na.rm = TRUE)
```



# Third Method

The workflow for this method is: 

Divide original bin data by the bin width that that bin is contributing to new bin width -> add bins together

```{r}
third_method <- fifteen_bin_data

third_method3$bin0 <- third_method3$bin0 * (1/3) #since it's in reverse chronological order, we go from enddate to end of the dataframe
third_method3$bin1 <- third_method3$bin1  * (1/3) # dividing by bin width
third_method3$bin2 <- third_method3$bin2 * (1/3)
third_method3$bin3 <- third_method3$bin3 * (1/3)
third_method3$bin4 <- third_method3$bin4 * (2/3)
third_method3$bin5 <- third_method3$bin5 * (1/2)
third_method3$bin6 <- third_method3$bin6 * (1/2)
third_method3$bin7 <- third_method3$bin7 * (1/2)
third_method3$bin8 <- third_method3$bin8 * (1/2)
third_method3$bin9 <- third_method3$bin9 * (1/3)
third_method3$bin10 <- third_method3$bin10 * (1/3)
third_method3$bin11 <- third_method3$bin11 * (1/3) 
third_method3$bin12 <- third_method3$bin12 * (1/3)
third_method3$bin13 <- third_method3$bin13 * (1/3)
third_method3$bin14 <- third_method3$bin14 * (1/3)

#next we add the bins together
third_method3$bin0 <- third_method3$bin0  + 
  third_method3$bin1 + third_method3$bin2

third_method3$bin1 <- third_method3$bin3 + third_method3$bin4

third_method3$bin2 <- third_method3$bin5  + third_method3$bin6

third_method3$bin3 <- third_method3$bin7 + third_method3$bin8

third_method3$bin4 <- third_method3$bin9  + 
  third_method3$bin10 + third_method3$bin11

third_method3$bin5 <- third_method3$bin12  + 
  third_method3$bin13 + third_method3$bin14

#getting rid of unused variables
third_method3$bin6 <- NULL
third_method3$bin7 <- NULL
third_method3$bin8 <- NULL
third_method3$bin9 <- NULL
third_method3$bin10 <- NULL
third_method3$bin11 <- NULL
third_method3$bin12 <- NULL
third_method3$bin13 <- NULL
third_method3$bin14 <- NULL

```
```{r}
mean(dates_to_keep$bin0, na.rm = TRUE)
mean(third_method$bin0, na.rm = TRUE)

```

```{r}
  timePlot(third_method, pollutant=c("bin0","bin1", "bin2", "bin3", "bin4", "bin5"), group=TRUE) #plot what it looks like now
  barplot(unlist(second_method3[100, c("bin0","bin1", "bin2", "bin3", "bin4", "bin5")]),
          main = "Particle Number vs Particle Size - Ex 1 Afterwards",
          names.arg = c("bin0","bin1", "bin2", "bin3", "bin4", "bin5"),
  )
  barplot(unlist(third_method[25, c("bin0","bin1", "bin2", "bin3", "bin4", "bin5")]),
          main = "Particle Number vs Particle Size - Ex 2 Afterwards ",
          names.arg = c("bin0","bin1", "bin2", "bin3", "bin4", "bin5"),
  )
```


# Fourth Method 

This is the method we went over in the Zoom meeting on 7/28.

```{r}
fourth_method <- fifteen_bin_data_filter

fourth_method$bin0 <- ( (fifteen_bin_data_filter$bin0 *0.05) + (fifteen_bin_data_filter$bin1 *0.05) + (fifteen_bin_data_filter$bin2 *0.05) ) / (0.15)

fourth_method$bin1 <- ( (fifteen_bin_data_filter$bin3 *0.05) + (fifteen_bin_data_filter$bin4 *0.1)  ) / (0.15)

fourth_method$bin2 <- ( (fifteen_bin_data_filter$bin5 *0.1) + (fifteen_bin_data_filter$bin6 *0.1)  ) / (0.15)

fourth_method$bin3 <- ( (fifteen_bin_data_filter$bin7 *0.1) + (fifteen_bin_data_filter$bin8 *0.1)  ) / (0.25)

fourth_method$bin4 <- ( (fifteen_bin_data_filter$bin9 *0.5) + (fifteen_bin_data_filter$bin10 *0.5)  + (fifteen_bin_data_filter$bin11 *0.5) ) / (1.5)

fourth_method$bin5 <- ( (fifteen_bin_data_filter$bin12 *2.5) + (fifteen_bin_data_filter$bin13 *2.5)  + (fifteen_bin_data_filter$bin14 *2.5) ) / (7.5)

```

```{r}
mean(fourth_method$bin0, na.rm = TRUE)
mean(six_bin_data_filter$bin0, na.rm = TRUE)
```
```{r}
pdf("result-bin-integration.pdf")
plot(c(fourth_method$date, six_bin_data_filter$date), c(fourth_method$bin0, six_bin_data_filter$bin0), type="l", main = "Bin 0 vs Time with Six Bin and Converted Six Bin Dataframes", xlab = "Date", ylab = "Bin 0 concentration")
abline(v = tail(fourth_method$date, n = 1), col = "red")
dev.off()
```
```{r}
pdf("better-six-bin-vis.pdf")
plot(fourth_method$date, fourth_method$bin0,type="l",col="red", xlim =  c(fourth_method$date[1], tail(six_bin_data_filter$date, n=1)), ylim = c(0, max(six_bin_data_filter$bin0, na.rm = TRUE)) , 
     main="Bin 0 Concentration vs Time", xlab = "Date", ylab = "Bin 0 Concentration")
lines(six_bin_data_filter$date, six_bin_data_filter$bin0,col="green")
abline(v = tail(fourth_method$date, n = 1), col = "black")
legend(x=fourth_method$date[20],y=150,c("Converted Bin Data","Six Bin Measured Data"),cex=.8, col=c("red","green"), pch=c(1,1))
dev.off()
```

# Changing the bins using the fourth method

```{r}
change_bins <- function(sn){
  
  six_bin_data <- sn[which( sn$bin14 == 0 & 
    sn$bin13 == 0 & 
              sn$bin12 == 0 & 
               sn$bin11 == 0 & 
               sn$bin10 == 0 &
               sn$bin9 == 0 & 
               sn$bin8 == 0 & 
               sn$bin7 == 0 &
               sn$bin6 == 0 
             ), ]
  
  
  six_bin_data_filter <- six_bin_data[!is.na(six_bin_data$bin0) & !is.na(six_bin_data$bin1) & !is.na(six_bin_data$bin2) & 
                                        !is.na(six_bin_data$bin3) & !is.na(six_bin_data$bin4) & !is.na(six_bin_data$bin5)
                                      , ]
  six_bin_data_filter <- six_bin_data_filter[which(rowSums(six_bin_data_filter[, c( "bin0", "bin1", "bin2", "bin3", "bin4", "bin5", "bin6", "bin7", "bin8", "bin9", "bin10", "bin11", "bin12", "bin13", "bin14")] )> 0.005),] 
  
  fifteen_bin_data <- sn[!(sn$date %in% six_bin_data$date), ]
  
  fifteen_bin_data_filter <- fifteen_bin_data[ !is.na(fifteen_bin_data$bin0) & !is.na(fifteen_bin_data$bin1) & 
                                             !is.na(fifteen_bin_data$bin2) & 
                                                 !is.na(fifteen_bin_data$bin3) & 
                                              !is.na(fifteen_bin_data$bin4) & !is.na(fifteen_bin_data$bin5) , ]
  
  fourth_method <- fifteen_bin_data_filter

  fourth_method$bin0 <- ( (fifteen_bin_data_filter$bin0 *0.05) + (fifteen_bin_data_filter$bin1 *0.05) + (fifteen_bin_data_filter$bin2 *0.05) ) / (0.15)
  
  fourth_method$bin1 <- ( (fifteen_bin_data_filter$bin3 *0.05) + (fifteen_bin_data_filter$bin4 *0.1)  ) / (0.15)
  
  fourth_method$bin2 <- ( (fifteen_bin_data_filter$bin5 *0.1) + (fifteen_bin_data_filter$bin6 *0.1)  ) / (0.15)
  
  fourth_method$bin3 <- ( (fifteen_bin_data_filter$bin7 *0.1) + (fifteen_bin_data_filter$bin8 *0.1)  ) / (0.25)
  
  fourth_method$bin4 <- ( (fifteen_bin_data_filter$bin9 *0.5) + (fifteen_bin_data_filter$bin10 *0.5)  + (fifteen_bin_data_filter$bin11 *0.5) ) / (1.5)
  
  fourth_method$bin5 <- ( (fifteen_bin_data_filter$bin12 *2.5) + (fifteen_bin_data_filter$bin13 *2.5)  + (fifteen_bin_data_filter$bin14 *2.5) ) / (7.5)
  
  sn[which(sn$date %in% fourth_method$date), c( "bin0", "bin1", "bin2", "bin3", "bin4", "bin5")] <- fourth_method[, c( "bin0", "bin1", "bin2", "bin3", "bin4", "bin5")]
  
  #getting rid of unused variables
  sn$bin6 <- NULL
  sn$bin7 <- NULL
  sn$bin8 <- NULL
  sn$bin9 <- NULL
  sn$bin10 <- NULL
  sn$bin11 <- NULL
  sn$bin12 <- NULL
  sn$bin13 <- NULL
  sn$bin14 <- NULL
  
  sn_filt <- sn
  return(sn_filt)
  
}
```


```{r}
sn45 <- change_bins(sn45)
write.csv(sn45, "sn45filt.csv", row.names = FALSE)
```

```{r}
#rm(sn45)
sn49 <- read.csv("data/sn49.csv", header= TRUE)
sn49$date <- ymd_hms(sn49$date,  tz = "America/New_York")
sn49$X <- NULL

sn49 <- change_bins(sn49)
write.csv(sn49, "sn49filt.csv", row.names = FALSE)
```


```{r}
rm(sn49)
sn62 <- read.csv("data/sn62.csv", header= TRUE)
sn62$date <- ymd_hms(sn62$date,  tz = "America/New_York")
sn62$X <- NULL

sn62 <- change_bins(sn62)
write.csv(sn62, "sn62filt.csv", row.names = FALSE)
```


```{r}
rm(sn62)
sn67 <- read.csv("data/sn67.csv", header= TRUE)
sn67$date <- ymd_hms(sn67$date,  tz = "America/New_York")
sn67$X <- NULL

sn67 <- change_bins(sn67)
write.csv(sn67, "sn67filt.csv", row.names = FALSE)
```

---
title: "hepa_impact"
author: "Megan Ku"
date: "3/4/2021"
output: html_document
---

```{r setup, warning= FALSE, error = FALSE}
library(lubridate) #date and time functions 
library(data.table) #to use the data.table variable type
library(dplyr) #this library allows you to use the %>% operator
library(tidyr) #this library lets you use the complete function to account for time syncing
library(openair) #for plotting and analysis
library(stringr)
library(readr) #read .csv files
library(ggplot2) #plotting
```

# HEPA Impact Plots for Revere City Hall and Revere VFW

This notebook focuses on creating visuals to highlight the impact of HEPA
purifiers on particle concentration in classrooms.

## Setup
In hepa_main.Rmd, un-comment the code in the chunk at line 486 to download the 
processed data as .csv files. This will be our starting point.


## Import Data

We will start by importing the datasets here. We need to manually set 
the values as doubles.

```{r}
waterdept_ratio <- read_csv('waterdept_ratio.csv')

auditor_ratio <- read_csv('auditor_ratio.csv', col_types = cols(
  concent_ratio = col_double(),
  concent_1.indoor = col_double(),
  concent_1.outdoor = col_double(),
  bin0_ratio = col_double(),
  bin0.indoor = col_double(),
  bin0.outdoor = col_double(),
  neph_bin0_ratio = col_double(),
  neph_bin0.indoor = col_double(),
  neph_bin0.outdoor = col_double(),
  pm1_ratio = col_double(),
  pm1.indoor = col_double(),
  pm1.outdoor = col_double(),
  pm25_ratio = col_double(),
  pm25.indoor = col_double(),
  pm25.outdoor = col_double(),
  pm10_ratio = col_double(),
  pm10.indoor = col_double(),
  pm10.outdoor = col_double()
))

mainroom_ratio <- read_csv('mainroom_ratio.csv', col_types = cols(
  concent_ratio = col_double(),
  concent_1.indoor = col_double(),
  concent_1.outdoor = col_double(),
  bin0_ratio = col_double(),
  bin0.indoor = col_double(),
  bin0.outdoor = col_double(),
  neph_bin0_ratio = col_double(),
  neph_bin0.indoor = col_double(),
  neph_bin0.outdoor = col_double(),
  pm1_ratio = col_double(),
  pm1.indoor = col_double(),
  pm1.outdoor = col_double(),
  pm25_ratio = col_double(),
  pm25.indoor = col_double(),
  pm25.outdoor = col_double(),
  pm10_ratio = col_double(),
  pm10.indoor = col_double(),
  pm10.outdoor = col_double()
))

# head(waterdept_ratio)
```

Looking at hepa_main.Rmd, it seems that it's more useful to keep all structures
as a list. That way, if we need to apply the same function to each data frame, 
we can do so with a function.

```{r}
ratio_list <- list(
  "auditor" = auditor_ratio,
  "waterdept" = waterdept_ratio,
  "mainroom" = mainroom_ratio
  # "engineering" = engineering_ratio
  )
```


To make the data frame more manageable, we'll only select specific columns. We 
will also calculate indoor/outdoor ratios for all particle sizes.


```{r}
simplify_ratio_data <- function(room) {
  room <- room %>%
    # Add/delete relevant columns here
    mutate(bin0_ratio = bin0.indoor/bin0.outdoor) %>%
    mutate(neph_bin0_ratio = neph_bin0.indoor/neph_bin0.outdoor) %>%
    mutate(pm25_ratio = pm25.indoor/pm25.outdoor) %>%
    mutate(pm10_ratio = pm10.indoor/pm10.outdoor) %>%
    select(date1min, 
           concent_ratio,
           concent_1.indoor,
           concent_1.outdoor,
           bin0_ratio,
           bin0.indoor,
           bin0.outdoor,
           neph_bin0_ratio,
           neph_bin0.indoor,
           neph_bin0.outdoor,
           pm1_ratio,
           pm1.indoor,
           pm1.outdoor,
           pm25_ratio,
           pm25.indoor,
           pm25.outdoor,
           pm10_ratio,
           pm10.indoor,
           pm10.outdoor)
    
  return(room)
}

ratio_list <- lapply(ratio_list,  function(x) simplify_ratio_data(x)) # Only save columns of importance 
```

Since times were imported as UTC, the below code block switches them back to
Eastern.

```{r}
time_to_eastern <- function(room) {
  tz(room$date1min) <- "America/New_York"
  return(room)
}

ratio_list <- lapply(ratio_list,  function(x) time_to_eastern(x)) # Fix time zone
```

Here, you can see a snippet of one of the data frames.

```{r}
head(ratio_list$auditor)
```

It is good practice that a dataset be *tidy*. We will make this data tidier by
transposing the columns.

```{r}
tidy_data <- function(room) {
  room <- room %>%
    pivot_longer(-date1min, names_to = "source", values_to = "ratio")
}

ratio_list <- lapply(ratio_list,  function(x) tidy_data(x))

head(ratio_list$auditor)
```

We will now filter the data for work hours to focus on the impact the purifiers
have on the people in these buildings. For City Hall and VFW, let's say that 
normal work hours are M-F from 8am to 5pm ET.

```{r}
filter_workday <- function(room) {
  room <- room %>%
    filter(hour(date1min) >= 8 & hour(date1min) <= 17) %>%
    filter(wday(date1min) %in% 2:6)
}

ratio_list <- lapply(ratio_list,  function(x) filter_workday(x))

ratio_list$waterdept
```
The main room has a lot of data points that go to (nearly) zero, so we're going 
to delete those rows. I inspected the data and noticed that these points were
scattered among 0 readings.

```{r}
ratio_list$mainroom <- ratio_list$mainroom %>%
  subset(ratio > 0.0001)
```


Let's filter the data for the times before and after the HEPA purifiers were
installed. Dataframes with '_HEPA' indicate data taken post HEPA purifier 
installation.

```{r}

ratio_list$auditor_HEPA <- ratio_list$auditor %>%
  filter(date1min > as.POSIXct("2021-01-19 09:20:00", tz='America/New_York'), 
         date1min < as.POSIXct("2021-01-25 09:03:00", tz='America/New_York'))

ratio_list$mainroom_HEPA <- ratio_list$mainroom %>%
  filter(date1min > as.POSIXct("2021-01-27 12:30:00", tz='America/New_York'), 
         date1min < as.POSIXct("2021-01-27 19:53:00", tz='America/New_York'))

ratio_list$waterdept_HEPA <- ratio_list$waterdept %>%
  filter(date1min > as.POSIXct("2021-01-11 10:05:00", tz='America/New_York'), 
         date1min < as.POSIXct("2021-01-13 12:08:00", tz='America/New_York'))

ratio_list$auditor <- ratio_list$auditor %>%
  filter(date1min > as.POSIXct("2021-01-13 12:49:00", tz='America/New_York'), 
         date1min < as.POSIXct("2021-01-19 09:20:00", tz='America/New_York'))

ratio_list$mainroom <- ratio_list$mainroom %>%
  filter(date1min > as.POSIXct("2021-01-25 09:58:00", tz='America/New_York'), 
         date1min < as.POSIXct("2021-01-27 12:30:00", tz='America/New_York'))

ratio_list$waterdept <- ratio_list$waterdept %>%
  filter(date1min > as.POSIXct("2021-01-06 08:45:00", tz='America/New_York'), 
         date1min < as.POSIXct("2021-01-11 10:05:00", tz='America/New_York'))
```

Let's calculate the mean concentration ratios before and after the HEPA 
installation, as well as the standard deviations. We'll store this in another 
dataset, which we will also tidy up.

```{r}
names = c("auditor", "waterdept", "mainroom", "auditor", "waterdept", "mainroom")

is_HEPA = c("pre", "pre", "pre", "post", "post", "post")

calculate_mean_ratio <- function(room) {
  
  # Calculate mean conc before and after for indoor, outdoor, and ratio
  # Calculate standard deviations for all as well
  conc <- room %>%
    filter(source=="concent_ratio") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(conc = "mean(ratio, na.rm = TRUE)")
  conc_sd <- room %>%
    filter(source=="concent_ratio") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(conc_sd = "sd(ratio, na.rm = TRUE)")
  conc.indoor <- room %>%
    filter(source=="concent_1.indoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(conc.indoor = "mean(ratio, na.rm = TRUE)")
  conc_sd.indoor <- room %>%
    filter(source=="concent_1.indoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(conc_sd.indoor = "sd(ratio, na.rm = TRUE)")  
  conc.outdoor <- room %>%
    filter(source=="concent_1.outdoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(conc.outdoor = "mean(ratio, na.rm = TRUE)")
  conc_sd.outdoor <- room %>%
    filter(source=="concent_1.outdoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(conc_sd.outdoor = "sd(ratio, na.rm = TRUE)")
  
  
  bin0 <- room %>%
    filter(source=="bin0_ratio") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(bin0 = "mean(ratio, na.rm = TRUE)")
  bin0_sd <- room %>%
    filter(source=="bin0_ratio") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(bin0_sd = "sd(ratio, na.rm = TRUE)")
  bin0.indoor <- room %>%
    filter(source=="bin0.indoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(bin0.indoor = "mean(ratio, na.rm = TRUE)")
  bin0_sd.indoor <- room %>%
    filter(source=="bin0.indoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(bin0_sd.indoor = "sd(ratio, na.rm = TRUE)")
    bin0.outdoor <- room %>%
    filter(source=="bin0.outdoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(bin0.outdoor = "mean(ratio, na.rm = TRUE)")
  bin0_sd.outdoor <- room %>%
    filter(source=="bin0.outdoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(bin0_sd.outdoor = "sd(ratio, na.rm = TRUE)")
  
  neph_bin0 <- room %>%
    filter(source=="neph_bin0_ratio") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(neph_bin0 = "mean(ratio, na.rm = TRUE)")
  neph_bin0_sd <- room %>%
    filter(source=="neph_bin0_ratio") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(neph_bin0_sd = "sd(ratio, na.rm = TRUE)")
  neph_bin0.indoor <- room %>%
    filter(source=="neph_bin0.indoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(neph_bin0.indoor = "mean(ratio, na.rm = TRUE)")
  neph_bin0_sd.indoor <- room %>%
    filter(source=="neph_bin0.indoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(neph_bin0_sd.indoor = "sd(ratio, na.rm = TRUE)")
  neph_bin0.outdoor <- room %>%
    filter(source=="neph_bin0.outdoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(neph_bin0.outdoor = "mean(ratio, na.rm = TRUE)")
  neph_bin0_sd.outdoor <- room %>%
    filter(source=="neph_bin0.outdoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(neph_bin0_sd.outdoor = "sd(ratio, na.rm = TRUE)")
  
  
  pm1 <- room %>%
    filter(source=="pm1_ratio") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(pm1 = "mean(ratio, na.rm = TRUE)")
  pm1_sd <- room %>%
    filter(source=="pm1_ratio") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(pm1_sd = "sd(ratio, na.rm = TRUE)")
  pm1.indoor <- room %>%
    filter(source=="pm1.indoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(pm1.indoor = "mean(ratio, na.rm = TRUE)")
  pm1_sd.indoor <- room %>%
    filter(source=="pm1.indoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(pm1_sd.indoor = "sd(ratio, na.rm = TRUE)")
  pm1.outdoor <- room %>%
    filter(source=="pm1.outdoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(pm1.outdoor = "mean(ratio, na.rm = TRUE)")
  pm1_sd.outdoor <- room %>%
    filter(source=="pm1.outdoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(pm1_sd.outdoor = "sd(ratio, na.rm = TRUE)")
  
  
  pm25 <- room %>%
    filter(source=="pm25_ratio") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(pm25 = "mean(ratio, na.rm = TRUE)")
  pm25_sd <- room %>%
    filter(source=="pm25_ratio") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(pm25_sd = "sd(ratio, na.rm = TRUE)")
  pm25.indoor <- room %>%
    filter(source=="pm25.indoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(pm25.indoor = "mean(ratio, na.rm = TRUE)")
  pm25_sd.indoor <- room %>%
    filter(source=="pm25.indoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(pm25_sd.indoor = "sd(ratio, na.rm = TRUE)")
  pm25.outdoor <- room %>%
    filter(source=="pm25.outdoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(pm25.outdoor = "mean(ratio, na.rm = TRUE)")
  pm25_sd.outdoor <- room %>%
    filter(source=="pm25.outdoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(pm25_sd.outdoor = "sd(ratio, na.rm = TRUE)")
  

  pm10 <- room %>%
    filter(source=="pm10_ratio") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(pm10 = "mean(ratio, na.rm = TRUE)")
  pm10_sd <- room %>%
    filter(source=="pm10_ratio") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(pm10_sd = "sd(ratio, na.rm = TRUE)")
  pm10.indoor <- room %>%
    filter(source=="pm10.indoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(pm10.indoor = "mean(ratio, na.rm = TRUE)")
  pm10_sd.indoor <- room %>%
    filter(source=="pm10.indoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(pm10_sd.indoor = "sd(ratio, na.rm = TRUE)")
  pm10.outdoor <- room %>%
    filter(source=="pm10.outdoor") %>%
    summarize(mean(ratio, na.rm=TRUE)) %>%
    rename(pm10.outdoor = "mean(ratio, na.rm = TRUE)")
  pm10_sd.outdoor <- room %>%
    filter(source=="pm10.outdoor") %>%
    summarize(sd(ratio, na.rm=TRUE)) %>%
    rename(pm10_sd.outdoor = "sd(ratio, na.rm = TRUE)")
  
  
  # Connect into one dataframe
  mean_ratios = cbind(conc, conc_sd, conc.indoor, conc_sd.indoor, conc.outdoor, conc_sd.outdoor,
                      bin0, bin0_sd, bin0.indoor, bin0_sd.indoor, bin0.outdoor, bin0_sd.outdoor,
                      neph_bin0, neph_bin0_sd, neph_bin0.indoor, neph_bin0_sd.indoor, neph_bin0.outdoor, neph_bin0_sd.outdoor, 
                      pm1, pm1_sd, pm1.indoor, pm1_sd.indoor, pm1.outdoor, pm1_sd.outdoor,
                      pm25, pm25_sd, pm25.indoor, pm25_sd.indoor, pm25.outdoor, pm25_sd.outdoor,
                      pm10, pm10_sd, pm10.indoor, pm10_sd.indoor, pm10.outdoor, pm10_sd.outdoor)
  return(mean_ratios)
}

mean_ratios <- lapply(ratio_list, function(x) calculate_mean_ratio(x)) %>%
  bind_rows() 

# Add labels to dataframe
mean_ratios <- cbind(name = names, mean_ratios)
mean_ratios <- cbind(mean_ratios, is_HEPA)

# Pivot wider for easier readability upon export
mean_ratios <- mean_ratios %>%
  pivot_wider(names_from = is_HEPA, names_sep = '.', values_from = -name) %>%
  mutate(conc_reduction = (conc.pre - conc.post)/conc.pre,
         bin0_reduction = (bin0.pre - bin0.post)/bin0.pre,
         neph_bin0_reduction = (neph_bin0.pre - neph_bin0.post)/neph_bin0.pre,
         pm1_reduction = (pm1.pre - pm1.post)/pm1.pre,
         pm25_reduction = (pm25.pre - pm25.post)/pm25.pre,
         pm10_reduction = (pm10.pre - pm10.post)/pm10.pre)

mean_ratios

```
Here, we'll export the data to a .csv file for further data analysis.

```{r}
write.table(mean_ratios, "revere_mean_ratios.csv", append = FALSE, sep = ",", dec = ".",
            row.names = FALSE, col.names = TRUE)
```


## Plot Concentration Changes

Let's investigate the data by using boxplots. Before we do that, though, we 
must distinguish which data is before and after the purifier installation.

```{r}
# Combine Water Department data
ratio_list$waterdept <- ratio_list$waterdept %>%
  mutate(is_HEPA = "no")

ratio_list$waterdept_HEPA <- ratio_list$waterdept_HEPA %>%
  mutate(is_HEPA = "yes")

waterdept_combined <- rbind(ratio_list$waterdept, ratio_list$waterdept_HEPA)


# Prep for boxplot
waterdept_boxplot_ratios <- waterdept_combined %>%
  filter(source == "concent_ratio" | source == "bin0_ratio"| source == "neph_bin0_ratio" | source == "pm1_ratio" | source == "pm25_ratio" | source ==  "pm10_ratio")

waterdept_boxplot_ratios$source <- factor(waterdept_boxplot_ratios$source , levels=c("concent_ratio", "bin0_ratio", "neph_bin0_ratio", 
                        "pm1_ratio", "pm25_ratio", "pm10_ratio"))

# Combine Auditor data
ratio_list$auditor <- ratio_list$auditor %>%
  mutate(is_HEPA = "no")

ratio_list$auditor_HEPA <- ratio_list$auditor_HEPA %>%
  mutate(is_HEPA = "yes")

auditor_combined <- rbind(ratio_list$auditor, ratio_list$auditor_HEPA)

auditor_boxplot_ratios <- auditor_combined %>%
  filter(source == "concent_ratio" | source == "bin0_ratio"| source == "neph_bin0_ratio" | source == "pm1_ratio" | source == "pm25_ratio" | source ==  "pm10_ratio")

# Prep for boxplot
auditor_boxplot_ratios$source <- factor(auditor_boxplot_ratios$source , levels=c("concent_ratio", "bin0_ratio", "neph_bin0_ratio", 
                        "pm1_ratio", "pm25_ratio", "pm10_ratio"))

# Combine Main Room data
ratio_list$mainroom <- ratio_list$mainroom %>%
  mutate(is_HEPA = "no")

ratio_list$mainroom_HEPA <- ratio_list$mainroom_HEPA %>%
  mutate(is_HEPA = "yes")

mainroom_combined <- rbind(ratio_list$mainroom, ratio_list$mainroom_HEPA)

mainroom_boxplot_ratios <- mainroom_combined %>%
  filter(source == "concent_ratio" | source == "bin0_ratio"| source == "neph_bin0_ratio" | source == "pm1_ratio" | source == "pm25_ratio" | source ==  "pm10_ratio")

# Prep for boxplot
mainroom_boxplot_ratios$source <- factor(mainroom_boxplot_ratios$source , levels=c("concent_ratio", "bin0_ratio", "neph_bin0_ratio", 
                        "pm1_ratio", "pm25_ratio", "pm10_ratio"))
```

```{r}
waterdept_boxplot_ratios
```
We will use the built-in ggplot2 boxplot and adjust the visuals to our needs.

### Water Department Room

```{r}

# Nice labels for facet_grid
source.labs <- c("CPC Conc.", "Bin 0", "Neph. Bin 0", "PM1", "PM2.5", "PM10")
names(source.labs) <- c("concent_ratio", "bin0_ratio", "neph_bin0_ratio", 
                        "pm1_ratio", "pm25_ratio", "pm10_ratio")

waterdept_boxplot <- ggplot(data=waterdept_boxplot_ratios, aes(x=source, y=ratio, fill=is_HEPA)) +
  geom_boxplot() +
  
  # separate visually by measurement and move labels to bottom of boxplot
  facet_grid(. ~ source, scales='free_x',
             labeller = labeller(source = source.labs),
             switch = "x") +
  
  # label graph
  labs(title="Effect of HEPA Purifiers on Particle Ratios",
       subtitle= "Revere City Hall: Water Department Room",
       x="Particle Ratio Type",
       y="Indoor/Outdoor Ratio") +

  # Change legend and use blue theme
  scale_fill_brewer(name = "Sensor Measurements",
                    labels = c("Initial Recording", 
                                 "After HEPA Installation"),
                    palette="Blues") +
  

  # Clean up axes
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()) +

  # Set limits  
  ylim(0,1)

waterdept_boxplot

# Save image
ggsave("waterdept_box.png")
```

### Auditor Room

```{r}
auditor_boxplot <- ggplot(data=auditor_boxplot_ratios, aes(x=source, y=ratio, fill=is_HEPA)) +
  geom_boxplot() +
  
  # separate visually by measurement and move labels to bottom of boxplot
  facet_grid(. ~ source, scales='free_x', 
             labeller = labeller(source = source.labs),
             switch = "x") +
  

  # label graph
  labs(title="Effect of HEPA Purifiers on Particle Ratios",
       subtitle= "Revere City Hall: Auditor Room",
       x="Particle Ratio Type",
       y="Indoor/Outdoor Ratio") +

  # Change legend and use blue theme
  scale_fill_brewer(name = "Sensor Measurements",
                  labels = c("Initial Recording", 
                               "After HEPA Installation"),
                  palette="Blues") +
  
  # Clean up axes
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()) +
  
  # Set limits
  ylim(0,1)

auditor_boxplot

# Save image
ggsave("auditor_box.png")
```
### VFW Main Room

```{r}
mainroom_boxplot <- ggplot(data=mainroom_boxplot_ratios, aes(x=source, y=ratio, fill=is_HEPA)) +
  geom_boxplot() +
  
  # separate visually by measurement and move labels to bottom of boxplot
  facet_grid(. ~ source, scales='free_x', 
             labeller = labeller(source = source.labs),
             switch = "x") +
  

  # label graph
  labs(title="Effect of HEPA Purifiers on Particle Ratios",
       subtitle= "VFW: Main Room",
       x="Particle Ratio Type",
       y="Indoor/Outdoor Ratio") +

  # Change legend and use blue theme
  scale_fill_brewer(name = "Sensor Measurements",
                  labels = c("Initial Recording", 
                               "After HEPA Installation"),
                  palette="Blues") +
  
  # Clean up axes
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()) +
  
  # Set limits
  ylim(0,1)

mainroom_boxplot

# Save image
ggsave("mainroom_box.png")
```


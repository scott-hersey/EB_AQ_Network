---
title: "hepa_impact"
author: "Megan Ku"
date: "3/4/2021"
output: html_document
---

```{r setup, warning= FALSE, error = FALSE}
library(lubridate) #date and time functions 
library(data.table) #to use the data.table variable type
library(dplyr) #this library allows you to use the %>% operator
library(tidyr) #this library lets you use the complete function to account for time syncing
library(openair) #for plotting and analysis
library(stringr)
library(readr) #read .csv files
library(ggplot2) #plotting
```

## HEPA Impact Plot

This notebook focuses on creating visuals to highlight the impact of HEPA
purifiers on particle concentration in classrooms.

### Setup
In hepa_main.Rmd, uncomment the code in the chunk at line 486 to download the 
processed data as .csv files. We will start by importing them here.

TODO: investigate why so many columns in auditor and mainroom are reading as 
logical instead of double
```{r}
waterdept_ratio <- read_csv('waterdept_ratio.csv')

auditor_ratio <- read_csv('auditor_ratio.csv', col_types = cols(
  concent_ratio = col_double()
))

mainroom_ratio <- read_csv('mainroom_ratio.csv', col_types = cols(
  concent_ratio = col_double()
))

head(waterdept_ratio)
```

```{r}
ratio_list <- list(
  "auditor" = auditor_ratio,
  "waterdept" = waterdept_ratio,
  "mainroom" = mainroom_ratio
  # "engineering" = engineering_ratio
  )
```


To make the data frame more manageable, we'll only select these columns:
date1min, 
concent_ratio, 
bin0.outdoor & bin0.indoor, 
neph_bin0.outdoor, & neph_bin0.indoor, 
pm1_ratio

```{r}
simplify_ratio_data <- function(room) {
  room <- room %>%
    # Add/delete relevant columns here
    mutate(bin0_ratio = bin0.indoor/bin0.outdoor) %>%
    mutate(neph_bin0_ratio = neph_bin0.indoor/neph_bin0.outdoor) %>%
    mutate(pm25_ratio = pm25.indoor/pm25.outdoor) %>%
    select(date1min, 
           concent_ratio, 
           bin0_ratio,
           neph_bin0_ratio,
           pm1_ratio,
           pm25_ratio)
    
  return(room)
}

ratio_list <- lapply(ratio_list,  function(x) simplify_ratio_data(x)) # Only save columns of importance 
```

Since times were imported as UTC, the below code block switches them back to
Eastern.

```{r}
time_to_eastern <- function(room) {
  tz(room$date1min) <- "America/New_York"
  return(room)
}

ratio_list <- lapply(ratio_list,  function(x) time_to_eastern(x)) # Only save columns of importance 
```

```{r}
print(ratio_list$auditor$date1min[1])
```

We will now filter the data for work hours to focus on the impact the purifiers
have on the people in these buildings. For City Hall and VFW, let's say that 
normal work hours are M-F from 8am to 5pm ET.

```{r}
filter_workday <- function(room) {
  room <- room %>%
    filter(hour(date1min) >= 8 & hour(date1min) <= 17) %>%
    filter(wday(date1min) %in% 2:6)
}

ratio_list <- lapply(ratio_list,  function(x) filter_workday(x))

ratio_list$waterdept
```
The main room has a lot of data points that go to (nearly) zero, so we're going 
to delete those rows. I inspected the data and noticed that these points were
scattered among 0 readings.

```{r}
ratio_list$mainroom <- ratio_list$mainroom %>%
  subset(concent_ratio > 0.0001)

print(nrow(subset(ratio_list$mainroom, concent_ratio < 0.0001)))
```


Let's filter the data for the times before and after the HEPA purifiers were
installed. Dataframes with '_HEPA' indicate data taken post HEPA purifier 
installation.

```{r}

ratio_list$auditor_HEPA <- ratio_list$auditor %>%
  filter(date1min > as.POSIXct("2021-01-19 09:20:00", tz='America/New_York'), 
         date1min < as.POSIXct("2021-01-25 09:03:00", tz='America/New_York'))

ratio_list$mainroom_HEPA <- ratio_list$mainroom %>%
  filter(date1min > as.POSIXct("2021-01-27 12:30:00", tz='America/New_York'), 
         date1min < as.POSIXct("2021-01-27 19:53:00", tz='America/New_York'))

ratio_list$waterdept_HEPA <- ratio_list$waterdept %>%
  filter(date1min > as.POSIXct("2021-01-11 10:05:00", tz='America/New_York'), 
         date1min < as.POSIXct("2021-01-13 12:08:00", tz='America/New_York'))

ratio_list$auditor <- ratio_list$auditor %>%
  filter(date1min > as.POSIXct("2021-01-13 12:49:00", tz='America/New_York'), 
         date1min < as.POSIXct("2021-01-19 09:20:00", tz='America/New_York'))

ratio_list$mainroom <- ratio_list$mainroom %>%
  filter(date1min > as.POSIXct("2021-01-25 09:58:00", tz='America/New_York'), 
         date1min < as.POSIXct("2021-01-27 12:30:00", tz='America/New_York'))

ratio_list$waterdept <- ratio_list$waterdept %>%
  filter(date1min > as.POSIXct("2021-01-06 08:45:00", tz='America/New_York'), 
         date1min < as.POSIXct("2021-01-11 10:05:00", tz='America/New_York'))
```

Let's calculate the mean concentration ratios before and after the HEPA 
installation.

```{r}
calculate_mean_ratio <- function(room) {
  conc <- room %>%
    summarize(mean(concent_ratio, na.rm=TRUE)) %>%
    rename(conc = "mean(concent_ratio, na.rm = TRUE)")
  bin0 <- room %>%
    summarize(mean(bin0_ratio, na.rm=TRUE)) %>%
    rename(bin0 = "mean(bin0_ratio, na.rm = TRUE)")
  neph_bin0 <- room %>%
    summarize(mean(neph_bin0_ratio, na.rm=TRUE)) %>%
    rename(neph_bin0 = "mean(neph_bin0_ratio, na.rm = TRUE)")
  pm1 <- room %>%
    summarize(mean(pm1_ratio, na.rm=TRUE)) %>%
    rename(pm1 = "mean(pm1_ratio, na.rm = TRUE)")
  pm25 <- room %>%
    summarize(mean(pm25_ratio, na.rm=TRUE)) %>%
    rename(pm25 = "mean(pm25_ratio, na.rm = TRUE)")

  
  mean_ratios = cbind(conc, bin0, neph_bin0, pm1, pm25)
  return(mean_ratios)
}

mean_concent_ratios <- lapply(ratio_list, function(x) calculate_mean_ratio(x))

mean_ratios <- bind_rows(mean_concent_ratios) 

names = c("auditor", "waterdept", "mainroom", "auditor_HEPA", "waterdept_HEPA", "mainroom_HEPA")

mean_ratios <- cbind(name = names, mean_ratios)

mean_ratios
```
```{r}
write.table(mean_ratios, "revere_mean_ratios.csv", append = FALSE, sep = ",", dec = ".",
            row.names = TRUE, col.names = TRUE)
```


Let's start with the Water Department Room. First we'll make a time-based plot to observe the change in concentration based on CPC data.

```{r}
waterdept_CPC_timeplot <- ggplot(data=ratio_list$waterdept, aes(x=date1min, y=concent_ratio)) + 
  # Data Points
  geom_point(aes(alpha=1/10)) +
  geom_point(data=ratio_list$waterdept_HEPA,
             aes(alpha=1/10)) +

  #Mean before HEPA
  geom_segment(
    aes(x=as.POSIXct("2021-01-06 8:46:00", tz='America/New_York'),
        y=mean_ratios$conc[1],
        xend=as.POSIXct("2021-01-11 10:05:00", tz='America/New_York'),
        yend=mean_ratios$conc[1],
        color="Mean Concentration Pre-HEPA"),
    lwd=1.25) +
  
  #Mean after HEPA
  geom_segment(
    aes(x=as.POSIXct("2021-01-11 10:05:00", tz='America/New_York'),
        y=mean_ratios$conc[4],
        xend=as.POSIXct("2021-01-13 12:08:00", tz='America/New_York'),
        yend=mean_ratios$conc[4],
        color="Mean Concentration Post-HEPA"),
    lwd=1.25) +

  #Installation
  geom_vline(
    aes(xintercept=as.POSIXct("2021-01-11 10:05:00", tz='America/New_York'),
        alpha=1,
        linetype='solid'),
    lwd=1.25) +
  
  #Labels
  labs(title="Effect of HEPA Purifiers on Air Concentration", 
       subtitle= "Revere City Hall: Water Department Room", 
       x="Date", 
       y="Indoor/Outdoor Particle Concentration (CPC)", 
       color="Metrics") +
  #Reverse order of legend
  guides(
    color = guide_legend(reverse=TRUE)
    ) +
  scale_linetype_discrete(
    name="", 
    labels = c('HEPA Purifier Installation')
    ) + 
  #limits
  ylim(0,1) +
  xlim(as.POSIXct("2021-01-06 8:46:00", tz='America/New_York'),as.POSIXct("2021-01-13 12:09:00", tz='America/New_York')) +
  #Omit gradient aesthetic of datapoints
  guides(alpha=FALSE)


waterdept_CPC_timeplot

ggsave("waterdept_timeplot.png")

```

```{r}
waterdept_CPC_timeplot <- ggplot(data=ratio_list$waterdept, aes(x=date1min, y=neph_bin0_ratio)) + 
  # Data Points
  geom_point(aes(alpha=1/10)) +
  geom_point(data=ratio_list$waterdept_HEPA,
             aes(alpha=1/10)) +

  #Mean before HEPA
  geom_segment(
    aes(x=as.POSIXct("2021-01-06 8:46:00", tz='America/New_York'),
        y=mean_ratios$neph_bin0[1],
        xend=as.POSIXct("2021-01-11 10:05:00", tz='America/New_York'),
        yend=mean_ratios$neph_bin0[1],
        color="Mean Concentration Pre-HEPA"),
    lwd=1.25) +
  
  #Mean after HEPA
  geom_segment(
    aes(x=as.POSIXct("2021-01-11 10:05:00", tz='America/New_York'),
        y=mean_ratios$neph_bin0[4],
        xend=as.POSIXct("2021-01-13 12:08:00", tz='America/New_York'),
        yend=mean_ratios$neph_bin0[4],
        color="Mean Concentration Post-HEPA"),
    lwd=1.25) +

  #Installation
  geom_vline(
    aes(xintercept=as.POSIXct("2021-01-11 10:05:00", tz='America/New_York'),
        alpha=1,
        linetype='solid'),
    lwd=1.25) +
  
  #Labels
  labs(title="Effect of HEPA Purifiers on Air Concentration", 
       subtitle= "Revere City Hall: Water Department Room", 
       x="Date", 
       y="Indoor/Outdoor Nephlometer Bin O Ratio", 
       color="Metrics") +
  #Reverse order of legend
  guides(
    color = guide_legend(reverse=TRUE)
    ) +
  scale_linetype_discrete(
    name="", 
    labels = c('HEPA Purifier Installation')
    ) + 
  #limits
  ylim(0,1) +
  xlim(as.POSIXct("2021-01-06 8:46:00", tz='America/New_York'),as.POSIXct("2021-01-13 12:09:00", tz='America/New_York')) +
  #Omit gradient aesthetic of datapoints
  guides(alpha=FALSE)


waterdept_CPC_timeplot

ggsave("waterdept_neph_bin0_timeplot.png")

```


Let's investigate the data by using a boxplot. Before we do that, though, we must make our data tidy.

```{r}
waterdept_tidy <- ratio_list$waterdept %>%
  gather('concent_ratio', 
'pm1_ratio', 'bin0_ratio', 'bin0_ratio', 'neph_bin0_ratio', 'pm25_ratio', key="ratio_type", value="value")

waterdept_HEPA_tidy <- ratio_list$waterdept_HEPA %>%
  rename(concent_ratio.HEPA = concent_ratio,
         pm1_ratio.HEPA = pm1_ratio,
         bin0_ratio.HEPA = bin0_ratio,
         neph_bin0_ratio.HEPA = neph_bin0_ratio,
         pm25_ratio.HEPA = pm25_ratio) %>%
  gather('concent_ratio.HEPA', 
'pm1_ratio.HEPA', 'bin0_ratio.HEPA', 'neph_bin0_ratio.HEPA', 'pm25_ratio.HEPA', key="ratio_type", value="value")

waterdept_tidy <- rbind(waterdept_tidy, waterdept_HEPA_tidy)

```


```{r}

waterdept_boxplot <- ggplot(data=waterdept_tidy, aes(x=ratio_type, y=value)) +
  geom_boxplot(aes(fill=ratio_type)) +
  
  # facet_grid(. ~ ratio_type, scales='free_x') +
  
  scale_x_discrete(breaks=c("bin0_ratio", "bin0_ratio.HEPA",
                            "concent_ratio", "concent_ratio.HEPA",
                            "neph_bin0_ratio", "neph_bin0_ratio.HEPA",
                            "pm1_ratio","pm1_ratio.HEPA", 
                            "pm25_ratio","pm25_ratio.HEPA"),
                   labels=c("Bin 0", "Bin 0 (HEPA)", 
                            "CPC Concent.", "CPC Concent. (HEPA)",
                            "Neph. Bin 0", "Neph. Bin 0 (HEPA)",
                            "PM1", "PM1 (HEPA)",
                            "PM2.5", "PM2.5 (HEPA)")) + 
  
  theme(axis.text.x = element_text(angle = 50, hjust=1)) + 
  
  labs(title="Effect of HEPA Purifiers on Particle Ratios", 
       subtitle= "Revere City Hall: Water Department Room", 
       x="Particle Ratio Type", 
       y="Indoor/Outdoor Ratio") +
  
  scale_fill_discrete(name = "Particle Ratio Type", 
                      labels = c("Bin 0", "Bin 0 (HEPA)", 
                                 "CPC Concentration", "CPC Concentration (HEPA)",
                                 "Nephlometer Bin 0", "Nephlometer Bin 0 (HEPA)",
                                 "PM1", "PM1 (HEPA)",
                                 "PM2.5", "PM2.5 (HEPA)")) + 
  
  ylim(0,1)

waterdept_boxplot
ggsave("waterdept_boxplot.png")
```



```{r}
auditor_CPC_timeplot <- ggplot(data=ratio_list$auditor, aes(x=date1min, y=concent_ratio)) + 
  # Data Points
  geom_point(aes(alpha=1/10)) +  
  geom_point(data=ratio_list$auditor_HEPA, 
             aes(alpha=1/10)) +

  #Mean before HEPA
  geom_segment(
    aes(x=as.POSIXct("2021-01-13 12:49:00", tz='America/New_York'), 
        y=mean_ratios$conc[2], 
        xend=as.POSIXct("2021-01-19 09:20:00", tz='America/New_York'), 
        yend=mean_ratios$conc[2], 
        color="Mean Concentration Pre-HEPA"),
    lwd=1.25) + 
  
  #Mean after HEPA
  geom_segment(
    aes(x=as.POSIXct("2021-01-19 09:20:00", tz='America/New_York'), 
        y=mean_ratios$conc[5], 
        xend=as.POSIXct("2021-01-25 09:03:00", tz='America/New_York'), 
        yend=mean_ratios$conc[5], 
        color="Mean Concentration Post-HEPA"), 
    lwd=1.25) +
    
  #Installation
  geom_vline(
    aes(xintercept=as.POSIXct("2021-01-19 09:20:00", tz='America/New_York'), 
        alpha=1, 
        linetype='solid'), 
    lwd=1.25) + 
  #Labels
  labs(title="Effect of HEPA Purifiers on Air Concentration", 
       subtitle= "Revere City Hall: Auditor Room", 
       x="Date", 
       y="Indoor/Outdoor Particle Concentration (CPC)", 
       color="Metrics") +
  #Reverse order of legend
  guides(
    color = guide_legend(reverse=TRUE)
    ) +
  scale_linetype_discrete(
    name="", 
    labels = c('HEPA Purifier Installation')
    ) + 
  #limits
  ylim(0,1) +
  xlim(as.POSIXct("2021-01-13 12:49:00", tz='America/New_York'),as.POSIXct("2021-01-25 09:03:00", tz='America/New_York')) +
  #Omit gradient aesthetic of datapoints
  guides(alpha=FALSE)

auditor_CPC_timeplot
ggsave("auditor_timeplot.png")
```
```{r}
auditor_tidy <- ratio_list$auditor %>%
  gather('concent_ratio', 
'pm1_ratio', 'bin0_ratio', 'bin0_ratio', 'neph_bin0_ratio', 'pm25_ratio', key="ratio_type", value="value")

auditor_HEPA_tidy <- ratio_list$auditor_HEPA %>%
  rename(concent_ratio.HEPA = concent_ratio,
         pm1_ratio.HEPA = pm1_ratio,
         bin0_ratio.HEPA = bin0_ratio,
         neph_bin0_ratio.HEPA = neph_bin0_ratio,
         pm25_ratio.HEPA = pm25_ratio) %>%
  gather('concent_ratio.HEPA', 
'pm1_ratio.HEPA', 'bin0_ratio.HEPA', 'neph_bin0_ratio.HEPA', 'pm25_ratio.HEPA', key="ratio_type", value="value")

auditor_tidy <- rbind(auditor_tidy, auditor_HEPA_tidy)

```


```{r}

auditor_boxplot <- ggplot(data=auditor_tidy, aes(x=ratio_type, y=value)) +
  geom_boxplot(aes(fill=ratio_type)) +
  
  # facet_grid(. ~ ratio_type, scales='free_x') +
  
  scale_x_discrete(breaks=c("bin0_ratio", "bin0_ratio.HEPA",
                            "concent_ratio", "concent_ratio.HEPA",
                            "neph_bin0_ratio", "neph_bin0_ratio.HEPA",
                            "pm1_ratio","pm1_ratio.HEPA", 
                            "pm25_ratio","pm25_ratio.HEPA"),
                   labels=c("Bin 0", "Bin 0 (HEPA)", 
                            "CPC Concent.", "CPC Concent. (HEPA)",
                            "Neph. Bin 0", "Neph. Bin 0 (HEPA)",
                            "PM1", "PM1 (HEPA)",
                            "PM2.5", "PM2.5 (HEPA)")) + 
  
  theme(axis.text.x = element_text(angle = 50, hjust=1)) + 
  
  labs(title="Effect of HEPA Purifiers on Particle Ratios", 
       subtitle= "Revere City Hall: Auditor Room", 
       x="Particle Ratio Type", 
       y="Indoor/Outdoor Ratio") +
  
  scale_fill_discrete(name = "Particle Ratio Type", 
                      labels = c("Bin 0", "Bin 0 (HEPA)", 
                                 "CPC Concentration", "CPC Concentration (HEPA)",
                                 "Nephlometer Bin 0", "Nephlometer Bin 0 (HEPA)",
                                 "PM1", "PM1 (HEPA)",
                                 "PM2.5", "PM2.5 (HEPA)")) + 
  
  ylim(0,1)

auditor_boxplot
ggsave("auditor_boxplot.png")
```

```{r}
mainroom_CPC_timeplot <- ggplot(data=ratio_list$mainroom, aes(x=date1min, y=concent_ratio)) + 
  # Data Points
  geom_point(aes(alpha=1/10)) +  
  geom_point(data=ratio_list$mainroom_HEPA, 
             aes(alpha=1/10)) +

  #Mean before HEPA
  geom_segment(
    aes(x=as.POSIXct("2021-01-25 09:50:00", tz='America/New_York'), 
        y=mean_ratios$conc[3], 
        xend=as.POSIXct("2021-01-27 12:30:00", tz='America/New_York'), 
        yend=mean_ratios$conc[3], 
        color="Mean Concentration Pre-HEPA"),
    lwd=1.25) + 
  
  #Mean after HEPA
  geom_segment(
    aes(x=as.POSIXct("2021-01-27 12:30:00", tz='America/New_York'), 
        y=mean_ratios$conc[6], 
        xend=as.POSIXct("2021-01-27 19:53:00", tz='America/New_York'), 
        yend=mean_ratios$conc[6], 
        color="Mean Concentration Post-HEPA"), 
    lwd=1.25) +
    
  #Installation
  geom_vline(
    aes(xintercept=as.POSIXct("2021-01-27 12:30:00", tz='America/New_York'), 
        alpha=1, 
        linetype='solid'), 
    lwd=1.25) + 
  #Labels
  labs(title="Effect of HEPA Purifiers on Air Concentration", 
       subtitle= "VFW: Main Room", 
       x="Date", 
       y="Indoor/Outdoor Particle Concentration (CPC)", 
       color="Metrics") + 
  #Reverse order of legend
  guides(
    color = guide_legend(reverse=TRUE)
    ) +
  scale_linetype_discrete(
    name="", 
    labels = c('HEPA Purifier Installation')
    ) + 
  #limits
  ylim(0,1) +
  xlim(as.POSIXct("2021-01-25 09:50:00", tz='America/New_York'),as.POSIXct("2021-01-27 19:53:00", tz='America/New_York')) +
  #Omit gradient aesthetic of datapoints
  guides(alpha=FALSE)

mainroom_CPC_timeplot
ggsave("mainroom_timeplot.png")
```

```{r}
mainroom_tidy <- ratio_list$mainroom %>%
  gather('concent_ratio', 
'pm1_ratio', 'bin0_ratio', 'bin0_ratio', 'neph_bin0_ratio', 'pm25_ratio', key="ratio_type", value="value")

mainroom_HEPA_tidy <- ratio_list$mainroom_HEPA %>%
  rename(concent_ratio.HEPA = concent_ratio,
         pm1_ratio.HEPA = pm1_ratio,
         bin0_ratio.HEPA = bin0_ratio,
         neph_bin0_ratio.HEPA = neph_bin0_ratio,
         pm25_ratio.HEPA = pm25_ratio) %>%
  gather('concent_ratio.HEPA', 
'pm1_ratio.HEPA', 'bin0_ratio.HEPA', 'neph_bin0_ratio.HEPA', 'pm25_ratio.HEPA', key="ratio_type", value="value")

mainroom_tidy <- rbind(mainroom_tidy, mainroom_HEPA_tidy)

```


```{r}
mainroom_boxplot <- ggplot(data=mainroom_tidy, aes(x=ratio_type, y=value)) +
  geom_boxplot(aes(fill=ratio_type)) +
  
  # facet_grid(. ~ ratio_type, scales='free_x') +
  
  scale_x_discrete(breaks=c("bin0_ratio", "bin0_ratio.HEPA",
                            "concent_ratio", "concent_ratio.HEPA",
                            "neph_bin0_ratio", "neph_bin0_ratio.HEPA",
                            "pm1_ratio","pm1_ratio.HEPA", 
                            "pm25_ratio","pm25_ratio.HEPA"),
                   labels=c("Bin 0", "Bin 0 (HEPA)", 
                            "CPC Concent.", "CPC Concent. (HEPA)",
                            "Neph. Bin 0", "Neph. Bin 0 (HEPA)",
                            "PM1", "PM1 (HEPA)",
                            "PM2.5", "PM2.5 (HEPA)")) + 
  
  theme(axis.text.x = element_text(angle = 50, hjust=1)) + 
  
  labs(title="Effect of HEPA Purifiers on Particle Ratios", 
       subtitle= "Revere City Hall: Main Room", 
       x="Particle Ratio Type", 
       y="Indoor/Outdoor Ratio") +
  
  scale_fill_discrete(name = "Particle Ratio Type", 
                      labels = c("Bin 0", "Bin 0 (HEPA)", 
                                 "CPC Concentration", "CPC Concentration (HEPA)",
                                 "Nephlometer Bin 0", "Nephlometer Bin 0 (HEPA)",
                                 "PM1", "PM1 (HEPA)",
                                 "PM2.5", "PM2.5 (HEPA)")) + 
  
  ylim(0,1)

mainroom_boxplot
ggsave("mainroom_boxplot.png")
```

```{r}
print(mean_ratios$conc[3])
```


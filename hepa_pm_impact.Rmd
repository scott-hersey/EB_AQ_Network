---
title: "hepa_pm_impact"
author: "Megan Ku"
date: "3/21/2021"
output: html_document
---

```{r setup, warning= FALSE, error = FALSE}
library(lubridate) #date and time functions 
library(data.table) #to use the data.table variable type
library(dplyr) #this library allows you to use the %>% operator
library(tidyr) #this library lets you use the complete function to account for time syncing
library(openair) #for plotting and analysis
library(stringr)
library(readr) #read .csv files
library(ggplot2) #plotting
```

Import data from the Engineering and Veterans Services rooms.

```{r}
engineering_ratio <- read_csv('engineering_ratio.csv', col_types = cols(
  bin0.indoor = col_double(),
  bin0.outdoor = col_double(),
  neph_bin0.indoor = col_double(),
  neph_bin0.outdoor = col_double(),
  pm25.indoor = col_double(),
  pm25.indoor = col_double(),
  pm1_ratio = col_double()
))

veterans_ratio <- read_csv('veterans_ratio.csv', col_types = cols(
  bin0.indoor = col_double(),
  bin0.outdoor = col_double(),
  neph_bin0.indoor = col_double(),
  neph_bin0.outdoor = col_double(),
  pm25.indoor = col_double(),
  pm25.indoor = col_double(),
  pm1_ratio = col_double()
))

ratio_list <- list(
  "engineering" = engineering_ratio,
  "veterans" = veterans_ratio
  )

ratio_list$veterans <- ratio_list$veterans %>%
  rename(date1min = date)

simplify_ratio_data <- function(room) {
  room <- room %>%
    # Add/delete relevant columns here
    mutate(bin0_ratio = bin0.indoor/bin0.outdoor) %>%
    mutate(neph_bin0_ratio = neph_bin0.indoor/neph_bin0.outdoor) %>%
    mutate(pm25_ratio = pm25.indoor/pm25.outdoor) %>%
    select(date1min,
           bin0_ratio,
           neph_bin0_ratio,
           pm1_ratio,
           pm25_ratio)
  return(room)
}

ratio_list <- lapply(ratio_list,  function(x) simplify_ratio_data(x)) # Only save columns of importance 

time_to_eastern <- function(room) {
  tz(room$date1min) <- "America/New_York"
  return(room)
}

ratio_list <- lapply(ratio_list,  function(x) time_to_eastern(x)) # Only save columns of importance

print(ratio_list$engineering$date1min[1])
```
We will now filter the data for work hours to focus on the impact the purifiers
have on the people in these buildings. For City Hall and VFW, let's say that 
normal work hours are M-F from 8am to 5pm ET.

```{r}
filter_workday <- function(room) {
  room <- room %>%
    filter(hour(date1min) >= 8 & hour(date1min) <= 17) %>%
    filter(wday(date1min) %in% 2:6)
}

ratio_list <- lapply(ratio_list,  function(x) filter_workday(x))
```

Let's filter the data for the times before and after the HEPA purifiers were
installed. Dataframes with '_HEPA' indicate data taken post HEPA purifier 
installation.

```{r}
ratio_list$engineering_HEPA <- ratio_list$engineering %>%
  filter(date1min > as.POSIXct("2021-01-11 10:45:00", tz='America/New_York'), 
         date1min < as.POSIXct("2021-01-13 12:15:00", tz='America/New_York'))

ratio_list$veterans_HEPA <- ratio_list$veterans %>%
  filter(date1min > as.POSIXct("2021-01-27 09:30:00", tz='America/New_York'), 
         date1min < as.POSIXct("2021-01-29 11:54:00", tz='America/New_York'))

ratio_list$engineering <- ratio_list$engineering %>%
  filter(date1min > as.POSIXct("2021-01-06 9:17:00", tz='America/New_York'), 
         date1min < as.POSIXct("2021-01-11 10:45:00", tz='America/New_York'))

ratio_list$veterans <- ratio_list$veterans %>%
  filter(date1min > as.POSIXct("2021-01-25 10:14:00", tz='America/New_York'), 
         date1min < as.POSIXct("2021-01-27 09:30:00", tz='America/New_York'))
```

```{r}
ratio_list
```

Let's calculate the mean concentration ratios before and after the HEPA 
installation.

```{r}
calculate_mean_ratio <- function(room) {
  bin0 <- room %>%
    summarize(mean(bin0_ratio, na.rm=TRUE)) %>%
    rename(bin0 = "mean(bin0_ratio, na.rm = TRUE)")
  neph_bin0 <- room %>%
    summarize(mean(neph_bin0_ratio, na.rm=TRUE)) %>%
    rename(neph_bin0 = "mean(neph_bin0_ratio, na.rm = TRUE)")
  pm1 <- room %>%
    summarize(mean(pm1_ratio, na.rm=TRUE)) %>%
    rename(pm1 = "mean(pm1_ratio, na.rm = TRUE)")
  pm25 <- room %>%
    summarize(mean(pm25_ratio, na.rm=TRUE)) %>%
    rename(pm25 = "mean(pm25_ratio, na.rm = TRUE)")

  
  mean_ratios = cbind(bin0, neph_bin0, pm1, pm25)
  return(mean_ratios)
}

mean_concent_ratios <- lapply(ratio_list, function(x) calculate_mean_ratio(x))

mean_ratios <- bind_rows(mean_concent_ratios) 

names = c("engineering", "veterans", "engineering_HEPA", "veterans_HEPA")

mean_ratios <- cbind(name = names, mean_ratios)

write.table(mean_ratios, "revere_mean_pm_ratios.csv", 
            append = FALSE, sep = ",", dec = ".",
            row.names = TRUE, col.names = TRUE)

mean_ratios
```

Let's make plots. We'll plot neph_bin0, pm1, and pm2.5 against time, then plot
all of those (and bin0) on a boxplot.

```{r}
veterans_tidy <- ratio_list$veterans %>%
  gather('pm1_ratio', 'bin0_ratio', 'bin0_ratio', 'neph_bin0_ratio', 
         'pm25_ratio', key="ratio_type", value="value")

veterans_HEPA_tidy <- ratio_list$veterans_HEPA %>%
  rename(pm1_ratio.HEPA = pm1_ratio,
         bin0_ratio.HEPA = bin0_ratio,
         neph_bin0_ratio.HEPA = neph_bin0_ratio,
         pm25_ratio.HEPA = pm25_ratio) %>%
  gather('pm1_ratio.HEPA', 'bin0_ratio.HEPA', 'neph_bin0_ratio.HEPA', 
         'pm25_ratio.HEPA', key="ratio_type", value="value")

veterans_tidy <- rbind(veterans_tidy, veterans_HEPA_tidy)
```
```{r}
veterans_boxplot <- ggplot(data=veterans_tidy, aes(x=ratio_type, y=value)) +
  geom_boxplot(aes(fill=ratio_type)) +
  
  # facet_grid(. ~ ratio_type, scales='free_x') +
  
  scale_x_discrete(breaks=c("bin0_ratio", "bin0_ratio.HEPA",
                            "neph_bin0_ratio", "neph_bin0_ratio.HEPA",
                            "pm1_ratio","pm1_ratio.HEPA", 
                            "pm25_ratio","pm25_ratio.HEPA"),
                   labels=c("Bin 0", "Bin 0 (HEPA)", 
                            "Neph. Bin 0", "Neph. Bin 0 (HEPA)",
                            "PM1", "PM1 (HEPA)",
                            "PM2.5", "PM2.5 (HEPA)")) + 
  
  theme(axis.text.x = element_text(angle = 50, hjust=1)) + 
  
  labs(title="Effect of HEPA Purifiers on Particle Ratios", 
       subtitle= "Revere City Hall: Veteran Services Room", 
       x="Particle Ratio Type", 
       y="Indoor/Outdoor Ratio") +
  
  scale_fill_discrete(name = "Particle Ratio Type", 
                      labels = c("Bin 0", "Bin 0 (HEPA)",
                                 "Nephlometer Bin 0", "Nephlometer Bin 0 (HEPA)",
                                 "PM1", "PM1 (HEPA)",
                                 "PM2.5", "PM2.5 (HEPA)")) + 
  
  ylim(0,1)

veterans_boxplot
ggsave("veterans_boxplot.png")
```


